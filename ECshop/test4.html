<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單詳情 API 測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> -->
    <style>
        .timeline {
            position: relative;
        }

        .timeline-item {
            position: relative;
        }

        .timeline-marker {
            position: relative;
            width: 20px;
            flex-shrink: 0;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 4px 4px 0 4px;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 16px;
            bottom: -16px;
            width: 2px;
            background-color: #dee2e6;
            transform: translateX(-50%);
        }

        .timeline-content {
            flex-grow: 1;
        }

        /* 狀態標籤顏色 */
        .status-waiting-payment {
            background-color: #f5f5f5 !important;
            color: #999 !important;
        }

        .status-waiting-ship {
            background-color: #fff7e6 !important;
            color: #fa8c16 !important;
        }

        .status-completed {
            background-color: #f6ffed !important;
            color: #52c41a !important;
        }

        .status-cancelled {
            background-color: #fff2f0 !important;
            color: #ff4d4f !important;
        }

        .status-refunded {
            background-color: #f9f0ff !important;
            color: #722ed1 !important;
        }

        .status-refunding {
            background-color: #fffbe6 !important;
            color: #faad14 !important;
        }

        .api-test-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .json-display {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-input {
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container mt-4" id="testApp">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-bug me-2"></i>訂單詳情 API 測試</h2>
                    <div class="d-flex align-items-center">
                        <span class="me-2">登入狀態:</span>
                        <span :class="isLoggedIn ? 'badge bg-success' : 'badge bg-danger'">
                            {{ isLoggedIn ? '已登入' : '未登入' }}
                        </span>
                    </div>
                </div>

                <!-- API 測試區域 -->
                <div class="api-test-section">
                    <h5><i class="bi bi-terminal me-2"></i>API 測試工具</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">測試端點：</label>
                                <select class="form-select" v-model="selectedEndpoint" @change="updateTestUrl">
                                    <option value="by-number">根據訂單編號查詢: /api/Orders/by-number/{orderNumber}</option>
                                    <option value="by-id">根據訂單ID查詢: /api/Orders/{orderId}</option>
                                    <option value="user-list">訂單列表: /api/Orders/user</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">參數輸入：</label>
                                <input type="text" class="form-control test-input" v-model="testParameter"
                                    :placeholder="getPlaceholder()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">完整 API URL：</label>
                                <div class="input-group">
                                    <span class="input-group-text">{{ baseUrl }}</span>
                                    <input type="text" class="form-control test-input" v-model="testUrl" readonly>
                                </div>
                            </div>
                            <button class="btn btn-primary me-2" @click="testApi" :disabled="isLoading">
                                <span v-if="isLoading" class="spinner-border spinner-border-sm me-1"></span>
                                {{ isLoading ? '測試中...' : '執行測試' }}
                            </button>
                            <button class="btn btn-outline-secondary" @click="clearResults">清除結果</button>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">回應狀態：</label>
                                <div v-if="apiResponse">
                                    <span :class="getStatusBadgeClass(apiResponse.status)">
                                        {{ apiResponse.status }} {{ apiResponse.statusText }}
                                    </span>
                                </div>
                                <div v-else class="text-muted">尚未執行測試</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">回應時間：</label>
                                <div v-if="responseTime">
                                    <span class="badge bg-info">{{ responseTime }}ms</span>
                                </div>
                                <div v-else class="text-muted">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- API 回應顯示 -->
                    <div v-if="apiResponse" class="mt-3">
                        <label class="form-label">原始回應 (JSON)：</label>
                        <div class="json-display">{{ formatJson(apiResponse.data) }}</div>
                    </div>
                </div>

                <!-- 訂單詳情顯示區域 -->
                <div v-if="orderDetail" class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>訂單詳情預覽</h5>
                    </div>
                    <div class="card-body">
                        <!-- 訂單基本資訊 -->
                        <div class="border rounded p-4 mb-4 bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">訂單資訊</h6>
                                    <p><strong>訂單編號：</strong> {{ orderDetail.orderNumber }}</p>
                                    <p><strong>下單時間：</strong> {{ formatDateTime(orderDetail.createdAt) }}</p>
                                    <p><strong>目前狀態：</strong>
                                        <span :class="getOrderStatusBadgeClass(orderDetail.currentStatusId)"
                                            class="badge">
                                            {{ orderDetail.currentStatus }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">金額資訊</h6>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>商品小計：</span>
                                        <span>NT$ {{ formatNumber(orderDetail.subtotalAmount) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>運費：</span>
                                        <span>NT$ {{ formatNumber(orderDetail.shippingFee) }}</span>
                                    </div>
                                    <div v-if="orderDetail.couponDiscount"
                                        class="d-flex justify-content-between mb-1 text-success">
                                        <span>優惠折扣：</span>
                                        <span>-NT$ {{ formatNumber(orderDetail.couponDiscount) }}</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>訂單總額：</strong>
                                        <strong class="text-danger">NT$ {{ formatNumber(orderDetail.totalAmount)
                                            }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 商品清單 -->
                        <div class="mb-4" v-if="orderDetail.orderItems && orderDetail.orderItems.length">
                            <h6 class="text-primary mb-3">商品清單</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>商品名稱</th>
                                            <th>單價</th>
                                            <th>數量</th>
                                            <th>小計</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in orderDetail.orderItems" :key="item.productId">
                                            <td>{{ item.productName }}</td>
                                            <td>NT$ {{ formatNumber(item.unitPrice) }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td class="text-danger"><strong>NT$ {{ formatNumber(item.subtotal)
                                                    }}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 收件人資訊 -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">收件人資訊</h6>
                            <div class="border rounded p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>收件人：</strong> {{ orderDetail.recipientName || '-' }}</p>
                                        <p><strong>聯絡電話：</strong> {{ orderDetail.recipientPhone || '-' }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>配送方式：</strong> {{ orderDetail.shippingMethod || '-' }}</p>
                                        <p><strong>配送地址：</strong> {{ orderDetail.shippingAddress || '-' }}</p>
                                    </div>
                                </div>
                                <div v-if="orderDetail.trackingCode">
                                    <p><strong>物流追蹤號：</strong>
                                        <span class="badge bg-info">{{ orderDetail.trackingCode }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 付款資訊 -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">付款資訊</h6>
                            <div class="border rounded p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>付款方式：</strong> {{ orderDetail.paymentMethod || '-' }}</p>
                                        <p><strong>付款狀態：</strong> {{ orderDetail.paymentStatus || '-' }}</p>
                                    </div>
                                    <div class="col-md-6" v-if="orderDetail.paidAt">
                                        <p><strong>付款時間：</strong> {{ formatDateTime(orderDetail.paidAt) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 狀態時間軸 -->
                        <div class="mb-4" v-if="orderDetail.statusHistory && orderDetail.statusHistory.length">
                            <h6 class="text-primary mb-3">訂單狀態歷程</h6>
                            <div class="timeline">
                                <div v-for="(status, index) in orderDetail.statusHistory" :key="index"
                                    class="timeline-item d-flex mb-3">
                                    <div class="timeline-marker me-3">
                                        <div class="timeline-dot bg-primary"></div>
                                        <div v-if="index < orderDetail.statusHistory.length - 1" class="timeline-line">
                                        </div>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span :class="getOrderStatusBadgeClass(status.statusId)" class="badge">
                                                {{ status.statusName }}
                                            </span>
                                            <small class="text-muted">{{ formatDateTime(status.createdAt) }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 常用測試案例 -->
                <div class="api-test-section">
                    <h5><i class="bi bi-lightning me-2"></i>快速測試</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2"
                                @click="quickTest('SO20250829120100001')">
                                測試訂單號: SO20250829120100001
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" @click="quickTestId(1)">
                                測試訂單ID: 1
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" @click="quickTestUserList()">
                                測試用戶訂單列表
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong class="me-auto">錯誤</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorToastBody">
                <!-- 錯誤訊息 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 引入你的 auth.js -->
    <!-- <script src="/assets/js/auth.js"></script> -->

    <script type="module">
        import * as auth from '/assets/js/auth.js';
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';


        // const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    baseUrl: 'https://localhost:7104/api/Orders',
                    selectedEndpoint: 'by-number',
                    testParameter: '',
                    testUrl: '/by-number/',
                    isLoading: false,
                    apiResponse: null,
                    responseTime: null,
                    orderDetail: null
                }
            },
            async mounted() {
                await this.checkLoginStatus();
                this.updateTestUrl();
            },
            methods: {
                async checkLoginStatus() {
                    // try {
                    //     const user = await auth.me();
                    //     this.isLoggedIn = !!user;
                    // } catch (error) {
                    //     this.isLoggedIn = false;
                    //     this.showError('請先登入會員');
                    // }
                    try {
                        const userInfo = await auth.me();
                        this.isLoggedIn = !!userInfo;
                        console.log('✅ 使用者已登入:', userInfo);
                    } catch (authError) {
                        this.isLoggedIn = false;
                        console.error('❌ 認證失敗，跳轉至登入頁');
                        // window.location.href = 'https://localhost:7184/VitalBridge/ECshop/index.html';
                        return;
                    }
                },

                getPlaceholder() {
                    switch (this.selectedEndpoint) {
                        case 'by-number':
                            return 'SO20250829113900001';
                        case 'by-id':
                            return '62';
                        case 'user-list':
                            return 'page=1&pageSize=10';
                        default:
                            return '';
                    }
                },

                updateTestUrl() {
                    switch (this.selectedEndpoint) {
                        case 'by-number':
                            this.testUrl = '/by-number/';
                            break;
                        case 'by-id':
                            this.testUrl = '/';
                            break;
                        case 'user-list':
                            this.testUrl = '/user?';
                            break;
                    }
                },

                async testApi() {
                    if (!this.isLoggedIn) {
                        this.showError('請先登入會員');
                        return;
                    }

                    if (!this.testParameter) {
                        this.showError('請輸入測試參數');
                        return;
                    }

                    this.isLoading = true;
                    this.apiResponse = null;
                    this.orderDetail = null;
                    this.responseTime = null;

                    try {
                        const startTime = Date.now();
                        let url = '';

                        switch (this.selectedEndpoint) {
                            case 'by-number':
                                url = `/by-number/${this.testParameter}`;
                                break;
                            case 'by-id':
                                url = `/${this.testParameter}`;
                                break;
                            case 'user-list':
                                url = `/user?${this.testParameter}`;
                                break;
                        }

                        // 取得 accessToken
                        const accessToken = window.auth.getAccessToken ? window.auth.getAccessToken() : null;

                        const response = await fetch(this.baseUrl + url, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {})
                            }
                        });

                        const endTime = Date.now();
                        this.responseTime = endTime - startTime;

                        const data = await response.json();

                        this.apiResponse = {
                            status: response.status,
                            statusText: response.statusText,
                            data: data
                        };

                        // 如果是成功的訂單詳情回應，設定顯示資料
                        if (response.ok && data.success && data.data && (this.selectedEndpoint === 'by-number' || this.selectedEndpoint === 'by-id')) {
                            this.orderDetail = data.data;
                        }

                    } catch (error) {
                        this.apiResponse = {
                            status: 0,
                            statusText: 'Network Error',
                            data: { error: error.message }
                        };
                        this.showError('API 請求失敗: ' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                quickTest(orderNumber) {
                    this.selectedEndpoint = 'by-number';
                    this.testParameter = orderNumber;
                    this.updateTestUrl();
                    this.testApi();
                },

                quickTestId(orderId) {
                    this.selectedEndpoint = 'by-id';
                    this.testParameter = orderId.toString();
                    this.updateTestUrl();
                    this.testApi();
                },

                quickTestUserList() {
                    this.selectedEndpoint = 'user-list';
                    this.testParameter = 'page=1&pageSize=5';
                    this.updateTestUrl();
                    this.testApi();
                },

                clearResults() {
                    this.apiResponse = null;
                    this.orderDetail = null;
                    this.responseTime = null;
                },

                getStatusBadgeClass(status) {
                    if (status >= 200 && status < 300) return 'badge bg-success';
                    if (status >= 400 && status < 500) return 'badge bg-warning';
                    if (status >= 500) return 'badge bg-danger';
                    return 'badge bg-secondary';
                },

                getOrderStatusBadgeClass(statusId) {
                    const statusClasses = {
                        1: 'status-waiting-payment',
                        2: 'status-waiting-ship',
                        3: 'status-completed',
                        4: 'status-cancelled',
                        5: 'status-refunded',
                        6: 'status-refunding'
                    };
                    return statusClasses[statusId] || 'bg-secondary';
                },

                formatDateTime(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-TW');
                },

                formatNumber(num) {
                    if (num === null || num === undefined) return '0';
                    return num.toLocaleString();
                },

                formatJson(obj) {
                    return JSON.stringify(obj, null, 2);
                },

                showError(message) {
                    const toastElement = document.getElementById('errorToast');
                    const toastBody = document.getElementById('errorToastBody');

                    if (toastBody) {
                        toastBody.textContent = message;
                    }

                    if (toastElement && window.bootstrap) {
                        const toast = new bootstrap.Toast(toastElement);
                        toast.show();
                    }
                }
            }
        }).mount('#testApp');
    </script>
</body>

</html>