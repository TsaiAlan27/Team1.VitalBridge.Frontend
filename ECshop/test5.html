<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>會員中心 - 樂齡橋 VitalBridge</title>
    <link href="/assets/img/favicon.png" rel="icon" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700;900&family=Raleway:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet" />
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />
    <link href="/assets/css/main.css" rel="stylesheet" />
    <link href="/assets/css/member-center.css" rel="stylesheet" />
    <style>
        .order-card {
            transition: box-shadow 0.2s ease;
            border: 1px solid #e9ecef;
        }

        .order-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .timeline {
            position: relative;
        }

        .timeline-item {
            position: relative;
        }

        .timeline-marker {
            position: relative;
            width: 20px;
            flex-shrink: 0;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 4px 4px 0 4px;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 16px;
            bottom: -16px;
            width: 2px;
            background-color: #dee2e6;
            transform: translateX(-50%);
        }

        .timeline-content {
            flex-grow: 1;
        }

        /* 狀態標籤顏色 */
        .status-waiting-payment {
            background-color: #f5f5f5 !important;
            color: #999 !important;
        }

        .status-waiting-ship {
            background-color: #fff7e6 !important;
            color: #fa8c16 !important;
        }

        .status-completed {
            background-color: #f6ffed !important;
            color: #52c41a !important;
        }

        .status-cancelled {
            background-color: #fff2f0 !important;
            color: #ff4d4f !important;
        }

        .status-refunded {
            background-color: #f9f0ff !important;
            color: #722ed1 !important;
        }

        .status-refunding {
            background-color: #fffbe6 !important;
            color: #faad14 !important;
        }
    </style>
</head>

<body>
    <div class="headerpage"></div>
    <main class="main py-4">
        <div class="container" data-aos="fade-up">
            <div class="row member-layout-row">
                <!-- 側邊導覽（純功能，不含頭像空間） -->
                <aside class="col-lg-3 col-xl-2 member-sidebar mb-3 mb-lg-0">
                    <nav class="nav flex-lg-column nav-pills gap-2 w-100" id="memberTab" role="tablist">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-dashboard"
                            type="button" role="tab">概覽</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-profile" type="button"
                            role="tab">個人資料</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-orders" type="button"
                            role="tab">訂單 / 紀錄</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-notify" type="button"
                            role="tab">通知中心</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-faq" type="button"
                            role="tab">常見問題</button>
                    </nav>
                </aside>
                <!-- 主內容 -->
                <div class="col-lg-9 col-xl-10">
                    <!-- 上方資訊列 -->
                    <div class="member-header mb-4">
                        <div class="row g-3 align-items-stretch">
                            <div class="col-12 col-md-6 info-col">
                                <h4 class="mb-1" id="memberName">--</h4>
                                <div class="text-muted small" id="memberEmail">--</div>
                                <div class="member-roles" id="memberRoles" hidden></div>
                            </div>
                            <div class="col-12 col-md-6 stats-col col-divider">
                                <div class="stats-col-inner member-quick-stats d-flex flex-wrap align-items-center">
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statUnread">--</div>
                                        <div class="stat-label">未讀通知</div>
                                    </div>
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statOrders">--</div>
                                        <div class="stat-label">訂單數</div>
                                    </div>
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statLastLogin">--</div>
                                        <div class="stat-label">最後登入</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-content member-content-area" id="memberTabContent">
                        <!-- 概覽 -->
                        <div class="tab-pane fade show active" id="pane-dashboard" role="tabpanel">
                            <div class="dashboard-quick-actions mb-4">
                                <div class="quick-actions-grid" id="quickActions">
                                    <div class="quick-action-card qa-profile" data-bs-toggle="pill"
                                        data-bs-target="#pane-profile" role="button" tabindex="0" aria-label="前往個人資料">
                                        <div class="qa-icon"><i class="bi bi-person-lines-fill"></i></div>
                                        <p class="qa-title">個人資料</p>
                                        <p class="qa-value" id="qaProfilePercent">--%</p>
                                        <div class="qa-meta">完整度</div>
                                    </div>
                                    <div class="quick-action-card qa-orders" data-bs-toggle="pill"
                                        data-bs-target="#pane-orders" role="button" tabindex="0" aria-label="前往訂單紀錄">
                                        <div class="qa-icon"><i class="bi bi-bag-check"></i></div>
                                        <p class="qa-title">訂單</p>
                                        <p class="qa-value" id="qaOrdersCount">--</p>
                                        <div class="qa-meta">筆數</div>
                                    </div>
                                    <div class="quick-action-card qa-notify" data-bs-toggle="pill"
                                        data-bs-target="#pane-notify" role="button" tabindex="0" aria-label="前往通知中心">
                                        <div class="qa-icon"><i class="bi bi-bell"></i></div>
                                        <p class="qa-title">通知</p>
                                        <p class="qa-value" id="qaNotifyUnread">--</p>
                                        <div class="qa-meta">未讀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body p-3 p-md-4">
                                    <h5 class="card-title mb-3">歡迎回來</h5>
                                    <p class="text-muted small mb-0">在上方資訊列可快速查看您的帳號概況，使用左側（或上方）導覽切換功能。</p>
                                </div>
                            </div>
                            <div class="card border-0 shadow-sm mb-4" id="orderStatusSummaryCard">
                                <div class="card-body p-3 p-md-4">
                                    <h6 class="card-title mb-3">訂單狀態概覽</h6>
                                    <div class="order-status-summary">
                                        <div class="oss-item status-unpaid">
                                            <div class="oss-icon"><i class="bi bi-exclamation-circle"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">未付款</span>
                                                <span class="oss-val" id="ossUnpaid">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-paid">
                                            <div class="oss-icon"><i class="bi bi-credit-card"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">已付款</span>
                                                <span class="oss-val" id="ossPaid">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-toship">
                                            <div class="oss-icon"><i class="bi bi-box-seam"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">待出貨</span>
                                                <span class="oss-val" id="ossToShip">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-shipped">
                                            <div class="oss-icon"><i class="bi bi-truck"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">已出貨</span>
                                                <span class="oss-val" id="ossShipped">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 個人資料 -->
                        <div class="tab-pane fade" id="pane-profile" role="tabpanel">
                            <div class="card border-0 shadow-sm profile-card mb-4">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                                        <h4 class="mb-0">個人資料</h4>
                                        <div class="small text-muted d-flex align-items-center gap-2">
                                            <span
                                                class="badge bg-light text-secondary fw-normal border profile-completeness-badge"
                                                id="profileCompletenessBadge">完整度 <span
                                                    id="qaProfilePercentInline">--%</span></span>
                                        </div>
                                    </div>
                                    <div class="profile-id-line">會員編號：<span id="profileId">--</span></div>
                                    <form id="formProfile" class="align-items-start">
                                        <!-- 區塊：基本資料 -->
                                        <div class="profile-section">
                                            <div class="profile-section-title"><i class="bi bi-person-badge"></i> 基本資料
                                            </div>
                                            <div class="row g-3 g-md-4">
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">姓名</label><input type="text"
                                                        class="form-control" id="profileName" required></div>
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">Email</label><input type="email"
                                                        class="form-control" id="profileEmail" disabled></div>
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">電話</label><input type="tel"
                                                        class="form-control" id="profilePhone"></div>
                                            </div>
                                        </div>
                                        <!-- 區塊：地址 -->
                                        <div class="profile-section">
                                            <div class="profile-section-title"><i class="bi bi-geo-alt"></i> 地址</div>
                                            <div class="row g-3 g-md-4">
                                                <div class="col-md-3 col-sm-6"><label class="form-label">縣市</label>
                                                    <select id="profileCity" class="form-select">
                                                        <option value="">請選擇</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 col-sm-6"><label class="form-label">鄉鎮</label>
                                                    <select id="profileDistrict" class="form-select" disabled>
                                                        <option value="">請先選縣市</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 col-12"><label
                                                        class="form-label">詳細地址</label><input type="text"
                                                        class="form-control" id="profileAddressDetail"
                                                        placeholder="例如: 建業路15號2樓1室"></div>
                                            </div>
                                        </div>
                                        <!-- 區塊：時間資訊 (簡單三行) -->
                                        <div class="profile-times small text-muted mb-3">
                                            <div>建立時間：<span id="profileCreatedAt">--</span></div>
                                            <div>最後修改：<span id="profileUpdatedAt">--</span></div>
                                            <div>最後登入：<span id="profileLastLoginAt">--</span></div>
                                        </div>
                                        <!-- 區塊：操作 -->
                                        <div class="profile-section mb-0 pb-0 border-0">
                                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                                <button class="btn btn-primary" type="submit">儲存變更</button>
                                                <span id="profileSaveStatus" class="text-muted small"></span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- 訂單 / 紀錄 -->
                        <!-- 訂單 / 記錄 -->
                        <div class="tab-pane fade" id="pane-orders" role="tabpanel">
                            <div id="ordersApp">

                            </div>
                        </div>
                        <!-- 通知中心 -->
                        <div class="tab-pane fade" id="pane-notify" role="tabpanel">
                            <h4 class="mb-3">通知中心</h4>
                            <div id="notifyList" class="list-group small">
                                <div class="text-muted">載入中...</div>
                            </div>
                        </div>
                        <!-- FAQ -->
                        <div class="tab-pane fade" id="pane-faq" role="tabpanel">
                            <h4 class="mb-3">常見問題</h4>
                            <div class="accordion" id="faqAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="faq1h"><button class="accordion-button"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#faq1">如何修改個人資料？</button></h2>
                                    <div id="faq1" class="accordion-collapse collapse show"
                                        data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">在「個人資料」分頁編輯後按儲存即可。</div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="faq2h"><button class="accordion-button collapsed"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#faq2">忘記密碼怎麼辦？</button></h2>
                                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">目前可透過客服或 Google 登入找回。</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="footerpage"></div>
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <div id="preloader"></div>
    <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/vendor/php-email-form/validate.js"></script>
    <script src="/assets/vendor/aos/aos.js"></script>
    <script src="/assets/vendor/waypoints/noframework.waypoints.js"></script>
    <script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
    <script src="/assets/js/fragment-loader.js" defer></script>
    <script src="/assets/js/member-center.js" defer></script>
    <script src="/assets/js/auth.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        // 強制需登入：未登入則導回首頁並開登入 modal（若可行）
        async function requireLogin() {
            if (typeof auth === 'undefined') { console.warn('auth 模組尚未載入'); return; }
            try { await auth.me(); return true; } catch (e) {
                // 直接導回首頁（首頁上的攔截程式或彈窗由 header 統一處理）
                window.location.href = '/VitalBridge/index.html?needLogin=1';
                return false;
            }
        }

        (function onFullyReady(run) {
            function once(ev) { return new Promise(res => { function h(e) { window.removeEventListener(ev, h); res(e); } window.addEventListener(ev, h); }); }
            function waitAppReady() { if (window.appReadyAt !== undefined) return Promise.resolve(); return once('app:ready'); }
            function waitWindowLoad() { if (document.readyState === 'complete') return Promise.resolve(); return once('load'); }
            Promise.all([waitAppReady(), waitWindowLoad()]).then(run).catch(e => console.error('post-load hook error', e));
        })(async function () {
            const ok = await requireLogin();
            if (!ok) return;
            initMemberPage();
        });

        async function initMemberPage() {
            try {
                const user = await auth.me();
                $('#memberName').text(user.name || '未命名');
                $('#memberEmail').text(user.email || '');
                renderUserRoles(user);
                // mock stats
                $('#statUnread').text('0');
                $('#statOrders').text('0');
                const now = new Date();
                $('#statLastLogin').text(formatDateTime(now));
                updateQuickProfileCompleteness();
                loadOrders();
                loadNotifies();
                populateProfileMeta(user);
            } catch (e) {
                $('.member-content-area').html('<div class="alert alert-warning">請先登入後再查看會員中心。</div>');
            }
            bindForms();
        }

        function bindForms() {
            $('#formProfile').on('submit', async function (e) {
                e.preventDefault();
                // 交由 member-center.js 的 updateProfile 控制；此處不再顯示 mock 文字
                if (window.memberCenter && typeof window.memberCenter.updateProfile === 'function') {
                    window.memberCenter.updateProfile();
                }
            });
            $('#orderFilter').on('change', function () { loadOrders(); });
        }

        function extractRoles(user) {
            if (!user || typeof user !== 'object') return [];
            const roleKeys = Object.keys(user).filter(k => /(roles|claims|identit|權限|角色)/i.test(k));
            let collected = [];
            for (const k of roleKeys) {
                const v = user[k];
                if (Array.isArray(v)) collected = collected.concat(v);
                else if (typeof v === 'string' && v.length && v.indexOf(',') > -1) collected = collected.concat(v.split(',').map(s => s.trim()));
                else if (typeof v === 'string' && v.length) collected.push(v.trim());
            }
            // 常見單一屬性
            if (user.role && !collected.length) collected.push(user.role);
            if (collected.length === 0 && user.isAdmin) collected.push('Admin');
            return [...new Set(collected.filter(Boolean))];
        }

        function roleBadgeClass(r) {
            const name = (r || '').toLowerCase();
            if (/admin|管理/.test(name)) return 'role-admin';
            if (/vip|premium|尊榮/.test(name)) return 'role-alt';
            if (/pending|未驗證|unverified/.test(name)) return 'role-warn';
            return '';
        }

        function renderUserRoles(user) {
            const roles = extractRoles(user);
            const box = document.getElementById('memberRoles');
            if (box) {
                if (!roles.length) { box.hidden = true; box.innerHTML = ''; }
                else { box.hidden = false; box.innerHTML = roles.map(r => `<span class="badge ${roleBadgeClass(r)}">${r}</span>`).join(''); }
            }
        }

        let allOrders = [];
        async function loadOrders() {
            const status = $('#orderFilter').val();
            // mock 加入多種狀態示例
            allOrders = [
                { id: 'O20250001', status: 'unpaid', total: 1234, date: '2025-08-01' },
                { id: 'O20250002', status: 'paid', total: 560, date: '2025-08-15' },
                { id: 'O20250003', status: 'toShip', total: 890, date: '2025-08-18' },
                { id: 'O20250004', status: 'shipped', total: 320, date: '2025-08-20' }
            ];
            const filtered = allOrders.filter(o => status === 'all' || o.status === status);
            const statusLabel = { unpaid: '未付款', paid: '已付款', toShip: '待出貨', shipped: '已出貨' };
            const list = filtered.map(o => `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><span><strong>${o.id}</strong><br><span class=\"text-muted small\">${o.date}</span></span><span class=\"badge bg-secondary\">${statusLabel[o.status] || o.status}</span></a>`).join('');
            $('#ordersList').html(list || '<div class="text-muted">無資料</div>');
            // 更新總數與快捷卡
            $('#statOrders').text(allOrders.length);
            $('#qaOrdersCount').text(allOrders.length);
            if (!allOrders.length) $('#qaOrdersCount').closest('.quick-action-card').addClass('dimmed'); else $('#qaOrdersCount').closest('.quick-action-card').removeClass('dimmed');
            updateOrderStatusSummary();
        }

        function updateOrderStatusSummary() {
            const counts = { unpaid: 0, paid: 0, toShip: 0, shipped: 0 };
            allOrders.forEach(o => { if (counts[o.status] !== undefined) counts[o.status]++; });
            $('#ossUnpaid').text(counts.unpaid);
            $('#ossPaid').text(counts.paid);
            $('#ossToShip').text(counts.toShip);
            $('#ossShipped').text(counts.shipped);
        }

        async function loadNotifies() {
            try { const res = await auth.apiFetch('/getNotify', { method: 'GET' }); if (!res.ok) throw new Error('fetch failed'); const data = await res.json(); if (!Array.isArray(data) || !data.length) { $('#notifyList').html('<div class="text-muted">暫無通知</div>'); return; } const html = data.map(n => `<div class=\"list-group-item\"><div class=\"d-flex justify-content-between\"><strong>${n.name || '通知'}</strong><span class=\"small text-muted\">${n.sendDate || ''}</span></div><div class=\"small\">${n.title || ''}</div>${n.notifysUrl ? `<a href=\"${n.notifysUrl}\" class=\"small\">前往</a>` : ''}</div>`).join(''); $('#notifyList').html(html); $('#statUnread').text(data.length); } catch (e) { $('#notifyList').html('<div class="text-muted">無法取得通知或尚未登入</div>'); }
            // 更新快捷未讀
            const unread = parseInt($('#statUnread').text(), 10) || 0;
            $('#qaNotifyUnread').text(unread);
            if (!unread) $('#qaNotifyUnread').closest('.quick-action-card').classList.add('dimmed');
        }

        function updateQuickProfileCompleteness() {
            // 基於目前填寫欄位簡單計算（姓名 / 電話 / 縣市 / 鄉鎮 / 詳細地址）
            const fields = ['#profileName', '#profilePhone', '#profileCity', '#profileDistrict', '#profileAddressDetail'];
            let filled = 0;
            fields.forEach(sel => { const v = $(sel).val?.() || ''; if (v && v.trim().length > 0) filled++; });
            const percent = Math.round((filled / fields.length) * 100);
            $('#qaProfilePercent').text(percent + '%');
            $('#qaProfilePercentInline').text(percent + '%');
            const card = $('#qaProfilePercent').closest('.quick-action-card');
            if (percent < 40) card.addClass('dimmed'); else card.removeClass('dimmed');
            // 百分比徽章色彩
            const badge = $('#profileCompletenessBadge');
            badge.removeClass('pc-low pc-mid pc-high');
            if (percent < 40) badge.addClass('pc-low');
            else if (percent < 80) badge.addClass('pc-mid');
            else badge.addClass('pc-high');
        }

        function populateProfileMeta(user) {
            if (!user) return;
            // 不在這裡預先顯示主鍵/會員編號，避免在 member-center.js 正式取得 profile 前出現閃爍或顯示真實主鍵
            // 真正的顯示（含可能的遮罩/格式化）交由 assets/js/member-center.js 的 fill() 處理
            $('#profileId').text('--');
            // 填寫基本欄位（若後端已有資料）
            if (user.name) $('#profileName').val(user.name);
            if (user.phone) $('#profilePhone').val(user.phone);
            if (user.email) $('#profileEmail').val(user.email);
            // 移除 bio 欄位
            // 地址拆解：嘗試以 縣/市 + 鄉/鎮/區
            const fullAddr = user.address || user.addr || '';
            if (fullAddr) {
                const m = fullAddr.match(/^(.{2,3}[市縣])\s?(.{2,3}[鄉鎮市區])\s?(.*)$/);
                if (m) {
                    if (m[1]) $('#profileCity').val(m[1]);
                    if (m[2]) $('#profileDistrict').val(m[2]);
                    if (m[3]) $('#profileAddressDetail').val(m[3]);
                } else {
                    $('#profileAddressDetail').val(fullAddr);
                }
            }
            // 時間欄位
            const created = user.createdAt || user.created_at || user.createTime || user.createdDate;
            const updated = user.updatedAt || user.updated_at || user.modifyTime || user.modifiedDate || user.lastModifiedAt;
            const lastLogin = user.lastLoginAt || user.last_login_at || user.lastLogin || user.lastLoginTime;
            if (created) $('#profileCreatedAt').text(formatDateTime(created));
            if (updated) $('#profileUpdatedAt').text(formatDateTime(updated));
            if (lastLogin) $('#profileLastLoginAt').text(formatDateTime(lastLogin)); else $('#profileLastLoginAt').text($('#statLastLogin').text());
            updateQuickProfileCompleteness();
            // 初始化完整度徽章同步
            $('#qaProfilePercentInline').text($('#qaProfilePercent').text());
        }
        // 測試內容-->
        const { createApp } = Vue;

        // 等 DOM 載入後初始化 Vue 應用
        document.addEventListener('DOMContentLoaded', function () {
            // 確保其他初始化完成後再啟動 Vue
            setTimeout(() => {
                const ordersApp = createApp({
                    data() {
                        return {
                            orders: [],
                            orderDetail: null,
                            currentStatus: 'all',
                            searchQuery: '',
                            searchTimeout: null,
                            pageSize: 10,
                            currentPage: 1,
                            isLoading: false,
                            pagination: {
                                currentPage: 1,
                                totalPages: 1,
                                pageSize: 10,
                                totalCount: 0
                            },
                            statusTabs: [
                                { value: 'all', label: '全部', count: 0 },
                                { value: '1', label: '待付款', count: 0 },
                                { value: '2', label: '待出貨', count: 0 },
                                { value: '3', label: '已完成', count: 0 },
                                { value: '4', label: '已取消', count: 0 },
                                { value: '5', label: '已退貨', count: 0 },
                                { value: '6', label: '退貨中', count: 0 }
                            ]
                        }
                    },
                    mounted() {
                        this.loadOrders();
                    },
                    template: `
                     <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="mb-0">我的訂單</h4>
                                </div>

                                <!-- 狀態標籤切換 -->
                                <div class="order-status-tabs mb-4">
                                    <div class="d-flex flex-wrap gap-2">
                                        <button v-for="status in statusTabs" :key="status.value"
                                            @click="switchStatus(status.value)"
                                            :class="['btn', 'btn-sm', currentStatus === status.value ? 'btn-primary' : 'btn-outline-secondary']">
                                            {{ status.label }}
                                            <span v-if="status.count > 0" class="badge bg-danger ms-1">{{ status.count
                                                }}</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- 搜尋框和分頁選擇 -->
                                <div class="row mb-4">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0">
                                                <i class="bi bi-search text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control border-start-0"
                                                placeholder="搜尋訂單編號、商品名稱或收件人姓名" v-model="searchQuery"
                                                @input="onSearchInput">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <label class="me-2 text-nowrap">顯示筆數:</label>
                                            <select class="form-select form-select-sm" v-model="pageSize"
                                                @change="changePageSize">
                                                <option value="10">10筆</option>
                                                <option value="20">20筆</option>
                                                <option value="200">全部</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- 訂單列表 -->
                                <div class="orders-list">
                                    <!-- 空狀態 -->
                                    <div v-if="orders.length === 0 && !isLoading" class="text-center py-5">
                                        <i class="bi bi-bag-x display-1 text-muted"></i>
                                        <h5 class="mt-3">暫無訂單資料</h5>
                                        <p class="text-muted">{{ searchQuery ? '找不到符合條件的訂單' : '您目前沒有任何訂單' }}</p>
                                    </div>

                                    <!-- 訂單卡片 -->
                                    <div v-for="order in orders" :key="order.orderNumber" class="card mb-3 order-card">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-8">
                                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                                        <div>
                                                            <strong class="text-dark">{{ order.orderNumber }}</strong>
                                                            <small class="text-muted ms-3">{{
                                                                formatDate(order.createdAt) }}</small>
                                                        </div>
                                                        <span :class="getStatusBadgeClass(order.statusId)"
                                                            class="badge">
                                                            {{ order.status }}
                                                        </span>
                                                    </div>
                                                    <div class="text-muted">
                                                        <small>共 {{ order.itemCount }} 件商品</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <div class="mb-2">
                                                        <span class="text-muted">訂單金額：</span>
                                                        <strong class="text-danger fs-5">NT$ {{
                                                            order.totalAmount.toLocaleString() }}</strong>
                                                    </div>
                                                    <button class="btn btn-outline-primary btn-sm"
                                                        @click="viewOrderDetail(order.orderNumber)">
                                                        查看詳情
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 訂單詳情 Modal -->
                                <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">訂單詳情</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div v-if="orderDetail" id="orderDetailContent">
                                                    <!-- 訂單基本資訊 -->
                                                    <div class="border rounded p-4 mb-4 bg-light">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <h6 class="text-primary mb-3">訂單資訊</h6>
                                                                <p><strong>訂單編號：</strong> {{ orderDetail.orderNumber }}
                                                                </p>
                                                                <p><strong>下單時間：</strong> {{
                                                                    formatDateTime(orderDetail.createdAt) }}</p>
                                                                <p><strong>目前狀態：</strong>
                                                                    <span
                                                                        :class="getStatusBadgeClass(orderDetail.currentStatusId)"
                                                                        class="badge">
                                                                        {{ orderDetail.currentStatus }}
                                                                    </span>
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <h6 class="text-primary mb-3">金額資訊</h6>
                                                                <div class="d-flex justify-content-between mb-1">
                                                                    <span>商品小計：</span>
                                                                    <span>NT$ {{
                                                                        orderDetail.subtotalAmount.toLocaleString()
                                                                        }}</span>
                                                                </div>
                                                                <div class="d-flex justify-content-between mb-1">
                                                                    <span>運費：</span>
                                                                    <span>NT$ {{
                                                                        orderDetail.shippingFee.toLocaleString()
                                                                        }}</span>
                                                                </div>
                                                                <div v-if="orderDetail.couponDiscount"
                                                                    class="d-flex justify-content-between mb-1 text-success">
                                                                    <span>優惠折扣：</span>
                                                                    <span>-NT$ {{
                                                                        orderDetail.couponDiscount.toLocaleString()
                                                                        }}</span>
                                                                </div>
                                                                <hr>
                                                                <div class="d-flex justify-content-between">
                                                                    <strong>訂單總額：</strong>
                                                                    <strong class="text-danger">NT$ {{
                                                                        orderDetail.totalAmount.toLocaleString()
                                                                        }}</strong>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 商品清單 -->
                                                    <div class="mb-4">
                                                        <h6 class="text-primary mb-3">商品清單</h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-hover">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>商品名稱</th>
                                                                        <th>單價</th>
                                                                        <th>數量</th>
                                                                        <th>小計</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="item in orderDetail.orderItems"
                                                                        :key="item.productId">
                                                                        <td>{{ item.productName }}</td>
                                                                        <td>NT$ {{ item.unitPrice.toLocaleString() }}
                                                                        </td>
                                                                        <td>{{ item.quantity }}</td>
                                                                        <td class="text-danger"><strong>NT$ {{
                                                                                item.subtotal.toLocaleString()
                                                                                }}</strong></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>

                                                    <!-- 收件人資訊 -->
                                                    <div class="mb-4">
                                                        <h6 class="text-primary mb-3">收件人資訊</h6>
                                                        <div class="border rounded p-3">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <p><strong>收件人：</strong> {{
                                                                        orderDetail.recipientName }}</p>
                                                                    <p><strong>聯絡電話：</strong> {{
                                                                        orderDetail.recipientPhone }}</p>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <p><strong>配送方式：</strong> {{
                                                                        orderDetail.shippingMethod }}</p>
                                                                    <p><strong>配送地址：</strong> {{
                                                                        orderDetail.shippingAddress }}</p>
                                                                </div>
                                                            </div>
                                                            <div v-if="orderDetail.trackingCode">
                                                                <p><strong>物流追蹤號：</strong>
                                                                    <span class="badge bg-info">{{
                                                                        orderDetail.trackingCode }}</span>
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 付款資訊 -->
                                                    <div class="mb-4">
                                                        <h6 class="text-primary mb-3">付款資訊</h6>
                                                        <div class="border rounded p-3">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <p><strong>付款方式：</strong> {{
                                                                        orderDetail.paymentMethod }}</p>
                                                                    <p><strong>付款狀態：</strong> {{
                                                                        orderDetail.paymentStatus }}</p>
                                                                </div>
                                                                <div class="col-md-6" v-if="orderDetail.paidAt">
                                                                    <p><strong>付款時間：</strong> {{
                                                                        formatDateTime(orderDetail.paidAt) }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 狀態時間軸 -->
                                                    <div class="mb-4">
                                                        <h6 class="text-primary mb-3">訂單狀態</h6>
                                                        <div class="timeline">
                                                            <div v-for="(status, index) in orderDetail.statusHistory"
                                                                :key="index" class="timeline-item d-flex mb-3">
                                                                <div class="timeline-marker me-3">
                                                                    <div class="timeline-dot bg-primary"></div>
                                                                    <div v-if="index < orderDetail.statusHistory.length - 1"
                                                                        class="timeline-line"></div>
                                                                </div>
                                                                <div class="timeline-content">
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center">
                                                                        <span
                                                                            :class="getStatusBadgeClass(status.statusId)"
                                                                            class="badge">
                                                                            {{ status.statusName }}
                                                                        </span>
                                                                        <small class="text-muted">{{
                                                                            formatDateTime(status.createdAt) }}</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Toast 容器 -->
                                <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
                                    <div id="errorToast" class="toast" role="alert" aria-live="assertive"
                                        aria-atomic="true">
                                        <div class="toast-header text-danger">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <strong class="me-auto">錯誤</strong>
                                            <button type="button" class="btn-close" data-bs-dismiss="toast"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="toast-body" id="errorToastBody">
                                            <!-- 錯誤訊息 -->
                                        </div>
                                    </div>
                                </div>




                                <!-- 分頁控制 -->
                                <nav v-if="pagination.totalPages > 1" class="mt-4">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" :class="{ disabled: pagination.currentPage <= 1 }">
                                            <button class="page-link" @click="changePage(pagination.currentPage - 1)"
                                                :disabled="pagination.currentPage <= 1">
                                                上一頁
                                            </button>
                                        </li>

                                        <li v-for="page in getVisiblePages()" :key="page" class="page-item"
                                            :class="{ active: page === pagination.currentPage }">
                                            <button class="page-link" @click="changePage(page)">{{ page }}</button>
                                        </li>

                                        <li class="page-item"
                                            :class="{ disabled: pagination.currentPage >= pagination.totalPages }">
                                            <button class="page-link" @click="changePage(pagination.currentPage + 1)"
                                                :disabled="pagination.currentPage >= pagination.totalPages">
                                                下一頁
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                    
                    
                    `,
                    methods: {
                        // 載入訂單列表
                        async loadOrders() {
                            try {
                                let url = `/api/Orders/user?page=${this.currentPage}&pageSize=${this.pageSize}`;

                                if (this.currentStatus !== 'all') {
                                    url += `&statusId=${this.currentStatus}`;
                                }

                                if (this.searchQuery.trim()) {
                                    url += `&search=${encodeURIComponent(this.searchQuery.trim())}`;
                                }

                                const response = await auth.apiFetch('/Orders/user' +
                                    `?page=${this.currentPage}&pageSize=${this.pageSize}` +
                                    (this.currentStatus !== 'all' ? `&statusId=${this.currentStatus}` : '') +
                                    (this.searchQuery.trim() ? `&search=${encodeURIComponent(this.searchQuery.trim())}` : '')
                                );

                                if (!response.ok) {
                                    throw new Error('載入失敗');
                                }

                                const result = await response.json();

                                if (result.success) {
                                    this.orders = result.data.orders;
                                    this.pagination = result.data.pagination;
                                } else {
                                    this.showError('載入訂單失敗');
                                }
                            } catch (error) {
                                console.error('載入訂單錯誤:', error);
                                this.showError('載入訂單失敗，請稍後再試');
                            }
                        },

                        // 切換狀態
                        switchStatus(status) {
                            this.currentStatus = status;
                            this.currentPage = 1;
                            this.loadOrders();
                        },

                        // 搜尋輸入處理（即時搜尋）
                        onSearchInput() {
                            if (this.searchTimeout) {
                                clearTimeout(this.searchTimeout);
                            }

                            this.searchTimeout = setTimeout(() => {
                                this.currentPage = 1;
                                this.loadOrders();
                            }, 500); // 500ms debounce
                        },

                        // 改變分頁大小
                        changePageSize() {
                            this.currentPage = 1;
                            this.loadOrders();
                        },

                        // 切換頁面
                        changePage(page) {
                            if (page >= 1 && page <= this.pagination.totalPages) {
                                this.currentPage = page;
                                this.loadOrders();
                            }
                        },

                        // 取得可見的頁碼
                        getVisiblePages() {
                            const current = this.pagination.currentPage;
                            const total = this.pagination.totalPages;
                            const delta = 2;

                            let start = Math.max(1, current - delta);
                            let end = Math.min(total, current + delta);

                            const pages = [];
                            for (let i = start; i <= end; i++) {
                                pages.push(i);
                            }
                            return pages;
                        },

                        // 查看訂單詳情
                        async viewOrderDetail(orderNumber) {
                            try {
                                const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                                modal.show();

                                const response = await auth.apiFetch(`/Orders/by-number/${orderNumber}`);

                                if (!response.ok) {
                                    throw new Error('載入失敗');
                                }

                                const result = await response.json();

                                if (result.success) {
                                    this.orderDetail = result.data;
                                } else {
                                    this.showError('載入訂單詳情失敗');
                                }
                            } catch (error) {
                                console.error('載入訂單詳情錯誤:', error);
                                this.showError('載入詳情失敗，請稍後再試');
                            }
                        },

                        // 取得狀態標籤樣式
                        getStatusBadgeClass(statusId) {
                            const statusClasses = {
                                1: 'status-waiting-payment',  // 待付款
                                2: 'status-waiting-ship',     // 待出貨
                                3: 'status-completed',        // 已完成
                                4: 'status-cancelled',        // 已取消
                                5: 'status-refunded',         // 已退貨
                                6: 'status-refunding'         // 退貨中
                            };
                            return statusClasses[statusId] || 'bg-secondary';
                        },

                        // 格式化日期
                        formatDate(dateStr) {
                            if (!dateStr) return '';
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('zh-TW');
                        },

                        // 格式化日期時間
                        formatDateTime(dateStr) {
                            if (!dateStr) return '';
                            const date = new Date(dateStr);
                            return date.toLocaleString('zh-TW');
                        },

                        // 顯示錯誤 Toast
                        showError(message) {
                            const toastElement = document.getElementById('errorToast');
                            const toastBody = document.getElementById('errorToastBody');

                            if (toastBody) {
                                toastBody.textContent = message;
                            }

                            if (toastElement && window.bootstrap) {
                                const toast = new bootstrap.Toast(toastElement, {
                                    autohide: true,
                                    delay: 3000
                                });
                                toast.show();
                            }
                        }
                    }
                });

                // 掛載到訂單區塊
                ordersApp.mount('#ordersApp');
            }, 100);
        });



        // 監聽個資欄位變更動態更新完整度
        $(document).on('input change', '#formProfile input', function () { updateQuickProfileCompleteness(); });

        function formatDateTime(dt) {
            try {
                const d = (dt instanceof Date) ? dt : new Date(dt);
                if (isNaN(d.getTime())) return '--';
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day} ${hh}:${mm}`;
            } catch { return '--'; }
        }
    </script>
</body>

</html>