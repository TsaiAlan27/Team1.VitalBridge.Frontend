<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>æ¨‚é½¡å•†åŸ</title>
  <meta name="description" content="å°ˆç‚ºéŠ€é«®æ—è¨­è¨ˆçš„å¥åº·å•†åŸ">
  <meta name="keywords" content="éŠ€é«®é£Ÿå“,ä¿å¥é£Ÿå“,å¥åº·é£²å“,ä¿å¥ç…§è­·">

  <!-- Favicons -->
  <link href="/assets/img/favicon.png" rel="icon">
  <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="/assets/css/main.css" rel="stylesheet">

  <!-- è‡ªå·±æƒ³æ”¹çš„æ¨£å¼æ”¾é€™é‚Š -->
  <style>
    body {
      background: linear-gradient(135deg, #a6f6fc 0%, #d7f7d7 100%);
      min-height: 100vh;
      /* display: flex; */
      align-items: center;
      justify-content: center;
      font-family: 'Poppins', sans-serif;
    }

    /* ğŸ”§ æ–°å¢ï¼šè®“ main å€åŸŸå±…ä¸­é¡¯ç¤º */
    .main {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 200px);
      padding: 2rem 0;
    }


    .success-container {
      background: white;
      border-radius: 20px;
      padding: 3rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      text-align: center;
      max-width: 500px;
      width: 90%;
      position: relative;
      overflow: hidden;
    }

    .success-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
    }

    .success-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 2rem;
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      animation: successPulse 2s ease-in-out infinite;
    }

    .success-icon i {
      font-size: 3rem;
      color: white;
      animation: checkmarkAnimation 0.8s ease-in-out 0.3s both;
    }

    @keyframes successPulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
      }

      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 20px rgba(40, 167, 69, 0);
      }
    }

    @keyframes checkmarkAnimation {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-title {
      font-size: 2rem;
      font-weight: 700;
      color: #28a745;
      margin-bottom: 1rem;
      animation: slideInUp 0.8s ease-out 0.5s both;
    }

    .success-message {
      font-size: 1.1rem;
      color: #6c757d;
      margin-bottom: 2rem;
      line-height: 1.6;
      animation: slideInUp 0.8s ease-out 0.7s both;
    }

    .order-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem 0;
      text-align: left;
      animation: slideInUp 0.8s ease-out 0.9s both;
    }

    .order-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #dee2e6;
    }

    .order-info-item:last-child {
      border-bottom: none;
    }

    .order-info-label {
      font-weight: 500;
      color: #495057;
    }

    .order-info-value {
      font-weight: 600;
      color: #212529;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      animation: slideInUp 0.8s ease-out 1.1s both;
    }

    .btn-home {
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none;
      color: white;
      padding: 1rem 2.5rem;
      border-radius: 50px;
      font-weight: 600;
      font-size: 1.1rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-home:hover {
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }

    .btn-orders {
      background: white;
      border: 2px solid #28a745;
      color: #28a745;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn-orders:hover {
      background: #28a745;
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    @keyframes slideInUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /*
    .celebration-confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #28a745;
      animation: confetti-fall linear infinite;
    }

    .confetti-piece:nth-child(2n) {
      background: #20c997;
    }

    .confetti-piece:nth-child(3n) {
      background: #17a2b8;
    }

    .confetti-piece:nth-child(4n) {
      background: #ffc107;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
*/
    .loading-state {
      display: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ğŸ”§ æ–°å¢ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .main {
        min-height: calc(100vh - 150px);
        padding: 1rem 0;
      }

      .success-container {
        padding: 2rem 1.5rem;
        margin: 0 1rem;
      }

      .success-title {
        font-size: 1.5rem;
      }

      .action-buttons {
        flex-direction: column;
        gap: 0.8rem;
      }

      .btn-home,
      .btn-orders {
        padding: 0.8rem 2rem;
        font-size: 1rem;
      }
    }
  </style>

</head>

<!-- <body class="index-page"> -->

<body>

  <div class="headerpage"></div> <!-- ä¸»å°è¦½ -->
  <div class="shop-headerpage"></div> <!-- è³¼ç‰©å°è¦½ -->



  <main class="main">
    <!-- ä½ å€‘çš„ä¸»è¦é é¢å…§å®¹æ”¾é€™é‚Šä¸‹é¢ -->
    <div id="payment-success-app">
      <!-- æ‰€æœ‰è³¼ç‰©ç›¸é—œå…§å®¹éƒ½æ”¾åœ¨é€™è£¡ -->
      <!-- æˆåŠŸç•«é¢ -->
      <div class="success-container">
        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div v-if="loading" class="loading-state" style="display: block;">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨ç¢ºèªä»˜æ¬¾ç‹€æ…‹...</p>
        </div>

        <!-- æˆåŠŸç‹€æ…‹ -->
        <div v-else>
          <!-- æˆåŠŸåœ–ç¤º -->
          <div class="success-icon">
            <i class="bi bi-check2"></i>
          </div>

          <!-- æˆåŠŸè¨Šæ¯ -->
          <h1 class="success-title">ä»˜æ¬¾æˆåŠŸï¼</h1>
          <p class="success-message">
            æ­å–œæ‚¨å®Œæˆä»˜æ¬¾ï¼æ‚¨çš„è¨‚å–®å·²ç¶“æˆåŠŸå»ºç«‹ï¼Œæˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†å’Œå‡ºè²¨ã€‚<br>
            æ„Ÿè¬æ‚¨é¸æ“‡æ¨‚é½¡å•†åŸï¼
          </p>
          <!-- è¨‚å–®è³‡è¨Š -->
          <div class="order-info" v-if="orderInfo">
            <div class="order-info-item">
              <span class="order-info-label">è¨‚å–®ç·¨è™Ÿ</span>
              <span class="order-info-value">{{ orderInfo.orderNumber }}</span>
            </div>
            <div class="order-info-item">
              <span class="order-info-label">ä»˜æ¬¾æ™‚é–“</span>
              <span class="order-info-value">{{ formatDateTime(orderInfo.paymentDate) }}</span>
            </div>
            <div class="order-info-item">
              <span class="order-info-label">ä»˜æ¬¾é‡‘é¡</span>
              <span class="order-info-value">NT$ {{ formatPrice(orderInfo.amount) }}</span>
            </div>
            <!-- <div class="order-info-item" v-if="orderInfo.transactionId">
            <span class="order-info-label">äº¤æ˜“ç·¨è™Ÿ</span>
            <span class="order-info-value">{{ orderInfo.transactionId }}</span>
          </div> -->
          </div>
          <!-- æ“ä½œæŒ‰éˆ• -->
          <div class="action-buttons">
            <a href="/VitalBridge/ECshop/index.html" class="btn-home">
              <i class="bi bi-house-fill"></i>
              å›åˆ°é¦–é 
            </a>
            <!--<a href="/VitalBridge/ECshop/order-history.html" class="btn-orders">
          <i class="bi bi-receipt"></i>
          æŸ¥çœ‹è¨‚å–®
          </a> -->
          </div>

        </div>

        <!-- å…¶ä»–é é¢å…§å®¹ä¹Ÿæœƒåœ¨é€™è£¡ -->
        <!-- ä½ å€‘çš„ä¸»è¦é é¢å…§å®¹æ”¾é€™é‚Šä¸Šé¢ -->
      </div>
  </main>

  <div class="footerpage"></div>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>
  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/vendor/php-email-form/validate.js"></script>
  <script src="/assets/vendor/aos/aos.js"></script>
  <script src="/assets/vendor/waypoints/noframework.waypoints.js"></script>
  <script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="/assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Main JS File -->
  <!-- <script src="assets/js/main.js"></script> -->


  <!-- å…¶ä»–è¦è£çš„jsæ”¾åœ¨é€™ä¹‹å‰ -->
  <script src="/assets/js/fragment-loader.js" defer></script>



</body>

<!-- Simple page hook: åœ¨ä¸‹é¢å€å¡Šç›´æ¥å¯«é é¢å°ˆå±¬çš„ JSï¼ˆæ­¤å‡½å¼æœƒç­‰åˆ° fragment-loader ç™¼å‡º app:ready ä¸” window.load å®Œæˆå¾ŒåŸ·è¡Œï¼‰ -->
<script>
  (function onFullyReady(run) {
    function once(ev) { return new Promise(res => { function h(e) { window.removeEventListener(ev, h); res(e); } window.addEventListener(ev, h); }); }
    function waitAppReady() { if (window.appReadyAt !== undefined) return Promise.resolve(); return once('app:ready'); }
    function waitWindowLoad() { if (document.readyState === 'complete') return Promise.resolve(); return once('load'); }
    Promise.all([waitAppReady(), waitWindowLoad()]).then(run).catch(function (e) { console.error('post-load hook error', e); });
  })(function () {
    // ===== åœ¨ä¸‹é¢æ”¾é é¢å°ˆå±¬çš„ JSï¼ˆåªæœƒåœ¨æ‰€æœ‰ç‰‡æ®µèˆ‡è³‡æºè¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œï¼‰ =====
    // ä¾‹å¦‚ï¼š
    // $(document).ready(function () {
    //   console.log("âœ… jQuery .ready() æ¸¬è©¦æˆåŠŸï¼");
    //   $("#hero h2").after("<p style='color:red;font-weight:bold;'>jQuery æ¸¬è©¦æ–‡å­—ï¼šè®€å–æˆåŠŸï¼</p>");
    // });
    // ç­‰å¾… auth ç‰©ä»¶è¼‰å…¥å®Œæˆ
    async function waitForAuth() {
      return new Promise((resolve) => {
        function checkAuth() {
          if (typeof window.auth !== 'undefined') {
            resolve();
          } else {
            setTimeout(checkAuth, 100); // æ¯ 100ms æª¢æŸ¥ä¸€æ¬¡
          }
        }
        checkAuth();
      });
    }

    //Vueçš„éƒ¨åˆ†å¯«é€™é‚Š
    (function mountVue() {
      // æŠŠé é¢å°ˆå±¬çš„ Vue ç¨‹å¼å¯«åœ¨é€™å€‹å‡½å¼è£¡
      function initPageVue() {
        if (typeof Vue === 'undefined') return; // è‹¥æœªè¼‰å…¥ Vue å‰‡è·³é
        const { createApp } = Vue;
        // ç¯„ä¾‹ï¼šæŠŠå¯¦éš›ç¨‹å¼æ”¹æˆä½ è¦çš„å…§å®¹

        createApp({
          data() { // data å°±æ˜¯Model
            return {
              loading: false,
              orderInfo: {
                orderNumber: null, // ç¤ºä¾‹æ•¸æ“š
                paymentDate: new Date().toISOString(),
                amount: null,
                transactionId: null,
                baseApiUrl: 'https://localhost:7104'
              }
            };
          },
          async mounted() {
            await waitForAuth(); // ç­‰å¾… auth è¼‰å…¥å®Œæˆ
            await this.checkPaymentResult();
          },
          methods: { // methods å°±æ˜¯Controller


            /**
           * è¼‰å…¥è¨‚å–®è³‡è¨Š
           */
            // å¾ URL å–å¾—è¨‚å–®ç·¨è™Ÿ
            getOrderNumberFromUrl() {
              const urlParams = new URLSearchParams(window.location.search);
              const orderNumber = urlParams.get('orderNumber');
              console.log('URL æŸ¥è©¢åƒæ•¸:', window.location.search);
              console.log('å–å¾—çš„è¨‚å–®ç·¨è™Ÿ:', orderNumber);
              return orderNumber; // éœ€è¦å›å‚³å€¼

            },
            // æª¢æŸ¥ä»˜æ¬¾çµæœ
            async checkPaymentResult() {

              try {
                this.loading = true;
                // 1. å¾ URL åƒæ•¸å–å¾—è¨‚å–®ç·¨è™Ÿ
                const orderNumber = this.getOrderNumberFromUrl(); // ä¿®æ­£ï¼šæ¥æ”¶å›å‚³å€¼

                if (!orderNumber) {
                  throw new Error('æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿ');
                }

                console.log('æŸ¥è©¢è¨‚å–®ç‹€æ…‹:', orderNumber);

                // 2. å…ˆç¢ºä¿ä½¿ç”¨è€…å·²ç™»å…¥ä¸¦å–å¾—æœ‰æ•ˆ token
                try {
                  await auth.me(); // é€™æœƒè‡ªå‹•è™•ç† token åˆ·æ–°
                  console.log('âœ… ä½¿ç”¨è€…èªè­‰æˆåŠŸ');
                } catch (authError) {
                  console.error('âŒ èªè­‰å¤±æ•—:', authError);
                  alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                  window.location.href = 'https://localhost:7184/VitalBridge/ECshop/index.html';
                  return;
                }

                // 3. å‘¼å«å¾Œç«¯API æŸ¥è©¢è¨‚å–®ç‹€æ…‹
                const response = await fetch(`${this.orderInfo.baseApiUrl}/api/Orders/payment-status/${orderNumber}`, {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json',
                    // å¦‚æœæœ‰ JWT tokenï¼Œéœ€è¦åŠ ä¸Š Authorization header
                    // 'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    'Authorization': `Bearer ${auth.getAccessToken()}`
                  }
                });

                if (!response.ok) {
                  if (response.status === 401) {
                    // Session éæœŸï¼Œå¼•å°é‡æ–°ç™»å…¥
                    alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    window.location.href = 'https://localhost:7184/VitalBridge/ECshop/index.html';
                    return;
                  }
                  throw new Error('ç„¡æ³•æŸ¥è©¢è¨‚å–®ç‹€æ…‹');
                }
                const result = await response.json();
                console.log('è¨‚å–®ç‹€æ…‹æŸ¥è©¢çµæœ:', result);

                // 3. æ›´æ–°è¨‚å–®è³‡è¨Š
                this.orderInfo = {
                  orderNumber: result.orderNumber,
                  paymentDate: result.paidAt || result.createdAt,
                  amount: result.totalAmount,
                  transactionId: result.transactionId,
                  baseApiUrl: this.orderInfo.baseApiUrl
                };
              }
              catch (error) {
                console.error('æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
                this.orderInfo = {
                  orderNumber: 'N/A',
                  paymentDate: new Date().toISOString(),
                  amount: 0,
                  baseApiUrl: this.orderInfo.baseApiUrl
                };
              } finally {
                this.loading = false;
              }
            },

            /**
             * æ ¼å¼åŒ–åƒ¹æ ¼
             */
            formatPrice(price) {
              if (!price) return '0';
              return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            },

            /**
             * æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
             */
            formatDateTime(dateString) {
              if (!dateString) return new Date().toLocaleString('zh-TW');

              try {
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit'
                });
              } catch (error) {
                return new Date().toLocaleString('zh-TW');
              }
            }
          }


        },
          // methods: { ... }, mounted() { ... } ç­‰å¯åœ¨æ­¤åŠ å…¥


        ).mount('#payment-success-app');
        console.log(" Vue EC mount æˆåŠŸï¼");
      }
      // ç«‹å³åŸ·è¡Œï¼ˆå¤–å±¤ post-load å·²ç¢ºä¿æ™‚æ©Ÿæ­£ç¢ºï¼‰
      initPageVue();
    })();
    // ===== åœ¨ä¸Šé¢æ”¾é é¢å°ˆå±¬çš„ JSï¼ˆåªæœƒåœ¨æ‰€æœ‰ç‰‡æ®µèˆ‡è³‡æºè¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œï¼‰ =====
  });
</script>

</html>