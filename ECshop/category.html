<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>å•†å“åˆ†é¡ - æ¨‚é½¡å•†åŸ</title>
    <meta name="description" content="å°ˆç‚ºéŠ€é«®æ—è¨­è¨ˆçš„å¥åº·å•†åŸ - å•†å“åˆ†é¡">
    <meta name="keywords" content="éŠ€é«®é£Ÿå“,ä¿å¥é£Ÿå“,å¥åº·é£²å“,ä¿å¥ç…§è­·">

    <!-- Favicons -->
    <link href="/assets/img/favicon.png" rel="icon">
    <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="/assets/css/main.css" rel="stylesheet">
    <style>
        /* å•†å“å¡ç‰‡æ¨£å¼ (æ²¿ç”¨é¦–é è¨­è¨ˆ) */
        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s ease;
            height: 100%;
            overflow: hidden;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #198754;
        }

        /* åœ–ç‰‡å®¹å™¨ - ç¢ºä¿æ­£æ–¹å½¢ */
        .product-image-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            /* 1:1 æ¯”ä¾‹ */
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .product-image:hover {
            transform: scale(1.05);
        }

        .product-info {
            padding: 18px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            cursor: pointer;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            min-height: 2.8em;
        }

        .product-name:hover {
            color: #198754;
        }

        .product-keypoint {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            min-height: 2.6em;
            flex: 1;
        }

        .product-price {
            font-size: 22px;
            font-weight: 700;
            color: #dc3545;
            margin-bottom: 15px;
            text-align: center;
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .btn-cart {
            background-color: #198754;
            border-color: #198754;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            margin-right: 8px;
        }

        .btn-cart:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .btn-cart:disabled:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            transform: none;
        }

        /* è¼‰å…¥å‹•ç•« */
        .spinner-border-sm {
            width: 0.875rem;
            height: 0.875rem;
        }

        .btn-cart:hover {
            background-color: #157347;
            border-color: #146c43;
            color: white;
            transform: translateY(-2px);
        }

        .btn-favorite {
            background: none;
            border: none;
            font-size: 22px;
            color: #ccc;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 8px;
            min-width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-favorite:hover {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            transform: scale(1.1);
        }

        .btn-favorite.active {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* åˆ†é æ§ä»¶æ¨£å¼ */
        .pagination .page-link {
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .pagination .page-link:hover {
            background-color: #e8f5e8;
            border-color: #198754;
            color: #198754;
        }

        .pagination .page-item.active .page-link {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }

        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            background-color: #f8f9fa;
            border-color: #dee2e6;
            cursor: not-allowed;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .product-image {
                height: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="fixed-top mb-5">
        <div class="headerpage"></div> <!-- ä¸»å°è¦½ -->
        <div class="shop-headerpage"></div> <!-- è³¼ç‰©å°è¦½ -->
    </div>

    <main class="main mt-5 pt-5">
        <div id="category-app" class="mt-2 pt-2">
            <div class="container">
                <!-- æ¨™é¡Œå€åŸŸ -->
                <section class="page-title-section py-4">
                    <h1 class="page-title">{{ pageTitle }}</h1>
                    <p class="page-subtitle text-muted">{{ pageSubtitle }}</p>
                </section>

                <!-- æ¸¬è©¦å€åŸŸ -->
                <!-- <section class="test-section py-4">
                    <div class="alert alert-info rounded-3">
                        <h5>æ¸¬è©¦è³‡è¨Šï¼š</h5>
                        <p><strong>ç•¶å‰åˆ†é¡IDï¼š</strong>{{ currentCategoryId || 'ç„¡' }}</p>
                        <p><strong>æœå°‹é—œéµå­—ï¼š</strong>{{ currentSearchQuery || 'ç„¡' }}</p>
                        <p><strong>ç•¶å‰é ç¢¼ï¼š</strong>{{ currentPage }}</p>
                        <p><strong>æ¯é æ•¸é‡ï¼š</strong>{{ pageSize }}</p>
                    </div>
                </section> -->
                <!-- å•†å“æ•¸é‡è³‡è¨Šå’Œç¯©é¸æ§ä»¶ -->
                <div class="products-info mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="text-muted mb-0" v-if="searchInfo">
                                æ‰¾åˆ° <strong>{{ searchInfo.totalFound }}</strong> å€‹å•†å“
                                <span v-if="currentSearchQuery">åŒ…å«ã€Œ{{ currentSearchQuery }}ã€</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <!-- æ’åºé¸æ“‡ -->
                                <div class="col-6">
                                    <select class="form-select form-select-sm rounded-3" v-model="currentSortBy"
                                        @change="handleSortChange">
                                        <option value="newest">æœ€æ–°ä¸Šæ¶</option>
                                        <option value="price_asc">åƒ¹æ ¼ï¼šä½ â†’ é«˜</option>
                                        <option value="price_desc">åƒ¹æ ¼ï¼šé«˜ â†’ ä½</option>
                                    </select>
                                </div>
                                <!-- æ¯é é¡¯ç¤ºæ•¸é‡ -->
                                <div class="col-6">
                                    <select class="form-select form-select-sm rounded-3" v-model="pageSize"
                                        @change="handlePageSizeChange">
                                        <option value="12">é¡¯ç¤º 12 å€‹</option>
                                        <option value="24">é¡¯ç¤º 24 å€‹</option>
                                        <option value="36">é¡¯ç¤º 36 å€‹</option>
                                        <option value="48">é¡¯ç¤º 48 å€‹</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å•†å“åˆ—è¡¨å€åŸŸ  -->
                <section class="products-section">
                    <!-- è¼‰å…¥ç‹€æ…‹ -->
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">è¼‰å…¥å•†å“è³‡æ–™ä¸­...</p>
                    </div>

                    <!-- éŒ¯èª¤ç‹€æ…‹ -->
                    <!-- <div v-else-if="error" class="alert alert-danger rounded-3" role="alert">
                        <h5 class="alert-heading">è¼‰å…¥å¤±æ•—</h5>
                        <p>{{ error }}</p>
                        <hr>
                        <button class="btn btn-outline-danger" @click="fetchProducts">é‡æ–°è¼‰å…¥</button>
                    </div> -->

                    <!-- ç„¡å•†å“çµæœ -->
                    <!-- <div v-else-if="products.length === 0" class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-search" style="font-size: 4rem; color: #6c757d;"></i>
                        </div>
                        <h4 class="text-muted">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å•†å“</h4>
                        <p class="text-muted">
                            <span v-if="currentSearchQuery">è©¦è©¦å…¶ä»–é—œéµå­—</span>
                            <span v-else-if="currentCategoryId">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰å•†å“</span>
                            <span v-else>ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„å•†å“</span>
                        </p>
                    </div> -->
                    <!-- å•†å“ç¶²æ ¼ -->
                    <div v-else>
                        <!-- å•†å“æ•¸é‡è³‡è¨Š -->
                        <!-- <div class="products-info mb-4">
                            <div class="row align-items-center">
                                <div class="col">
                                    <p class="text-muted mb-0" v-if="searchInfo">
                                        æ‰¾åˆ° <strong>{{ searchInfo.totalFound }}</strong> å€‹å•†å“
                                        <span v-if="currentSearchQuery">åŒ…å«ã€Œ{{ currentSearchQuery }}ã€</span>
                                    </p>
                                </div>
                            </div>
                        </div> -->

                        <!-- å•†å“åˆ—è¡¨ -->
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6 col-6" v-for="product in products" :key="product.id">
                                <div class="card product-card">
                                    <div class="product-image-container">
                                        <img :src="getImageUrl(product.imageFileName)" :alt="product.name"
                                            class="product-image" @click="goToProduct(product.id)"
                                            @error="handleImageError">
                                    </div>
                                    <div class="product-info">
                                        <h5 class="product-name" @click="goToProduct(product.id)">
                                            {{ truncateName(product.name) }}
                                        </h5>
                                        <p class="product-keypoint">{{ product.keypoint }}</p>
                                        <div class="product-price">NT$ {{ formatPrice(product.price) }}</div>
                                        <div class="product-actions">
                                            <!-- <button class="btn btn-cart" @click="addToCartFromList(product)">
                                                <i class="bi bi-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
                                            </button> -->
                                            <!-- å•†å“åˆ—è¡¨é é¢çš„æŒ‰éˆ• -->
                                            <button class="btn btn-cart" @click="addToCartFromList(product)"
                                                :disabled="isAddingToCart(product.id)">
                                                <span v-if="isAddingToCart(product.id)">
                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                    åŠ å…¥ä¸­...
                                                </span>
                                                <span v-else>
                                                    <i class="bi bi-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
                                                </span>
                                            </button>
                                            <button class="btn-favorite" :class="{ active: isFavorite(product.id) }"
                                                @click="toggleFavorite(product.id)">
                                                <i class="bi bi-heart-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åˆ†é æ§ä»¶ -->
                        <div class="pagination-section mt-5" v-if="pagination && pagination.totalPages > 1">
                            <nav aria-label="å•†å“åˆ†é å°èˆª">
                                <ul class="pagination justify-content-center">
                                    <!-- ä¸Šä¸€é  -->
                                    <li class="page-item" :class="{ disabled: !pagination.hasPreviousPage }">
                                        <button class="page-link rounded-3 me-2"
                                            @click="goToPage(pagination.currentPage - 1)"
                                            :disabled="!pagination.hasPreviousPage">
                                            <i class="bi bi-chevron-left"></i> ä¸Šä¸€é 
                                        </button>
                                    </li>

                                    <!-- é ç¢¼ -->
                                    <li class="page-item" v-for="pageNum in getPageNumbers()" :key="pageNum"
                                        :class="{ active: pageNum === pagination.currentPage }">
                                        <button class="page-link rounded-3 mx-1" @click="goToPage(pageNum)"
                                            :class="{ 'bg-success border-success': pageNum === pagination.currentPage }">
                                            {{ pageNum }}
                                        </button>
                                    </li>

                                    <!-- ä¸‹ä¸€é  -->
                                    <li class="page-item" :class="{ disabled: !pagination.hasNextPage }">
                                        <button class="page-link rounded-3 ms-2"
                                            @click="goToPage(pagination.currentPage + 1)"
                                            :disabled="!pagination.hasNextPage">
                                            ä¸‹ä¸€é  <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </li>
                                </ul>
                            </nav>

                            <!-- åˆ†é è³‡è¨Š -->
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    ç¬¬ {{ pagination.currentPage }} é ï¼Œå…± {{ pagination.totalPages }} é 
                                    (ç¸½å…± {{ pagination.totalItems }} å€‹å•†å“)
                                </small>
                            </div>
                        </div>
                    </div>



                </section>
            </div>
        </div>
    </main>

    <div class="footerpage"></div>

    <!-- Vendor JS Files -->
    <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/cart-utils.js"></script>
    <script src="/assets/js/fragment-loader.js" defer></script>


</body>

<!-- Vue é‚è¼¯ -->
<script>
    (function onFullyReady(run) {
        function once(ev) { return new Promise(res => { function h(e) { window.removeEventListener(ev, h); res(e); } window.addEventListener(ev, h); }); }
        function waitAppReady() { if (window.appReadyAt !== undefined) return Promise.resolve(); return once('app:ready'); }
        function waitWindowLoad() { if (document.readyState === 'complete') return Promise.resolve(); return once('load'); }
        Promise.all([waitAppReady(), waitWindowLoad()]).then(run).catch(function (e) { console.error('post-load hook error', e); });
    })(function () {

        (function mountVue() {
            if (typeof Vue === 'undefined') return;
            const { createApp } = Vue;

            createApp({
                data() {
                    return {
                        // URL åƒæ•¸
                        currentCategoryId: null,
                        currentSearchQuery: null,
                        currentPage: 1,
                        pageSize: 12,
                        currentSortBy: 'newest', // æ–°å¢ï¼šæ’åºé¸é …// é è¨­ç‚ºæœ€æ–°ä¸Šæ¶

                        // é é¢è³‡è¨Š
                        pageTitle: 'è¼‰å…¥ä¸­...',
                        pageSubtitle: '',
                        // API è³‡æ–™
                        products: [],           // å•†å“åˆ—è¡¨
                        pagination: null,       // åˆ†é è³‡è¨Š
                        searchInfo: null,       // æœå°‹è³‡è¨Š

                        // ç‹€æ…‹ç®¡ç†
                        loading: false,         // è¼‰å…¥ç‹€æ…‹
                        error: null,           // éŒ¯èª¤è¨Šæ¯
                        addingToCart: false, // ğŸ”¥ æ–°å¢ï¼šé˜²æ­¢é‡è¤‡é»æ“Š

                        // æˆ‘çš„æœ€æ„› (æ²¿ç”¨é¦–é é‚è¼¯)
                        favorites: JSON.parse(localStorage.getItem('vitalbridge_favorites') || '[]'),
                        addingToCartId: null,  // è¨˜éŒ„æ­£åœ¨åŠ å…¥è³¼ç‰©è»Šçš„å•†å“ID


                    };
                },

                mounted() {
                    console.log('Category page Vue mounted');
                    this.parseUrlParams();
                    this.updatePageTitle();
                    this.fetchProducts(); // æ–°å¢ï¼šè¼‰å…¥å•†å“è³‡æ–™
                },

                methods: {
                    // è§£æ URL åƒæ•¸
                    parseUrlParams() {
                        const urlParams = new URLSearchParams(window.location.search);

                        // è®€å–åƒæ•¸
                        this.currentCategoryId = urlParams.get('categoryId') ? parseInt(urlParams.get('categoryId')) : null;
                        this.currentSearchQuery = urlParams.get('searchQuery') || null;
                        this.currentPage = urlParams.get('page') ? parseInt(urlParams.get('page')) : 1;
                        this.pageSize = urlParams.get('pageSize') ? parseInt(urlParams.get('pageSize')) : 12;

                        console.log('è§£æçš„ URL åƒæ•¸:', {
                            categoryId: this.currentCategoryId,
                            searchQuery: this.currentSearchQuery,
                            page: this.currentPage,
                            pageSize: this.pageSize
                        });
                    },

                    // æ›´æ–°é é¢æ¨™é¡Œ
                    updatePageTitle() {
                        if (this.currentSearchQuery) {
                            this.pageTitle = `æœå°‹çµæœ`;
                            this.pageSubtitle = `é—œéµå­—ï¼š${this.currentSearchQuery}`;
                        } else if (this.currentCategoryId) {
                            // å¦‚æœæœ‰å¾ API å›å‚³çš„åˆ†é¡åç¨±ï¼Œä½¿ç”¨å®ƒ
                            // this.pageTitle = `å•†å“åˆ†é¡`;
                            // this.pageSubtitle = `åˆ†é¡IDï¼š${this.currentCategoryId}`;
                            if (this.searchInfo?.categoryName) {
                                this.pageTitle = this.searchInfo.categoryName;
                                this.pageSubtitle = 'ç€è¦½æ­¤åˆ†é¡çš„å•†å“';
                            } else {
                                this.pageTitle = 'å•†å“åˆ†é¡';
                                // this.pageSubtitle = `åˆ†é¡IDï¼š${this.currentCategoryId}`;
                            }

                        } else {
                            this.pageTitle = 'æ‰€æœ‰å•†å“';
                            this.pageSubtitle = 'ç€è¦½å…¨éƒ¨å•†å“';
                        }
                    },
                    // æ–°å¢ï¼šAPI å‘¼å«æ–¹æ³•
                    async fetchProducts() {
                        this.loading = true;
                        this.error = null;

                        try {
                            // å»ºæ§‹ API URL
                            const params = new URLSearchParams();


                            if (this.currentCategoryId) {
                                params.append('categoryId', this.currentCategoryId);
                            }

                            if (this.currentSearchQuery) {
                                params.append('searchQuery', this.currentSearchQuery);
                            }
                            if (this.currentSortBy && this.currentSortBy !== 'newest') {
                                params.append('sortBy', this.currentSortBy);
                            }

                            params.append('page', this.currentPage);
                            params.append('pageSize', this.pageSize);

                            const apiUrl = `https://localhost:7104/api/ProductsApi/Products?${params.toString()}`;
                            console.log('API å‘¼å« URL:', apiUrl);

                            // å‘¼å« API
                            const response = await fetch(apiUrl);

                            if (!response.ok) {
                                throw new Error(`API å‘¼å«å¤±æ•—: ${response.status}`);
                            }

                            const data = await response.json();
                            console.log('API å›å‚³è³‡æ–™:', data);

                            // æ›´æ–°è³‡æ–™
                            this.products = data.products || [];
                            this.pagination = data.pagination || null;
                            this.searchInfo = data.searchInfo || null;

                            // æ›´æ–°é é¢æ¨™é¡Œ (ä½¿ç”¨ API å›å‚³çš„åˆ†é¡åç¨±)
                            // if (this.searchInfo?.categoryName) {
                            //     this.pageSubtitle = this.searchInfo.categoryName;
                            // }
                            // ä¿®æ”¹ï¼šåœ¨ API è³‡æ–™è¼‰å…¥å¾Œç«‹å³æ›´æ–°é é¢æ¨™é¡Œ
                            this.updatePageTitle();

                        } catch (error) {
                            console.error('è¼‰å…¥å•†å“å¤±æ•—:', error);
                            this.error = error.message;
                            this.products = [];

                        } finally {
                            this.loading = false;
                        }
                    },
                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šå–å¾—åœ–ç‰‡ URL
                    getImageUrl(fileName) {
                        if (!fileName) return '/assets/img/default-product.jpg';
                        return `https://localhost:7184/api/UploadFile/GetFile/${encodeURIComponent(fileName)}`;
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šåœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
                    handleImageError(event) {
                        event.target.src = '/assets/img/default-product.jpg';
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šåƒ¹æ ¼æ ¼å¼åŒ–
                    formatPrice(price) {
                        if (!price) return '0';
                        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šå•†å“åç¨±æˆªæ–·
                    truncateName(name) {
                        if (!name) return '';
                        if (name.length <= 50) return name;
                        return name.substring(0, 50) + '...';
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šå‰å¾€å•†å“è©³æƒ…
                    goToProduct(productId) {
                        window.location.href = `/VitalBridge/ECshop/product-detail.html?id=${productId}`;
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šåŠ å…¥è³¼ç‰©è»Š (åŸæœ¬okï¼Œåªæ˜¯æ”¹å¯«å¼•ç”¨çš„æ–¹å¼)
                    // async addToCart(product) {
                    //     // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                    //     if (!this.checkLoginStatus()) {
                    //         alert('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½åŠ å…¥è³¼ç‰©è»Š');
                    //         window.location.href = '/VitalBridge/index.html';
                    //         return;
                    //     }

                    //     // é˜²æ­¢é‡è¤‡é»æ“Š
                    //     if (this.addingToCart) return;
                    //     this.addingToCart = true;

                    //     try {
                    //         // ç¢ºä¿ token æœ‰æ•ˆ
                    //         try {
                    //             await auth.me();
                    //         } catch (authError) {
                    //             console.error('ç™»å…¥æª¢æŸ¥å¤±æ•—ï¼Œå˜—è©¦åˆ·æ–° token:', authError);
                    //             try {
                    //                 await auth.ensureRefreshed();
                    //             } catch (refreshError) {
                    //                 alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    //                 window.location.href = '/VitalBridge/index.html';
                    //                 return;
                    //             }
                    //         }

                    //         // å‘¼å«åŠ å…¥è³¼ç‰©è»Š API
                    //         const response = await fetch('https://localhost:7104/api/CartApi/AddItem', {
                    //             method: 'POST',
                    //             headers: {
                    //                 'Content-Type': 'application/json',
                    //                 'Authorization': `Bearer ${auth.getAccessToken()}`
                    //             },
                    //             credentials: 'include',
                    //             body: JSON.stringify({
                    //                 productId: product.id,
                    //                 quantity: 1
                    //             })
                    //         });

                    //         if (!response.ok) {
                    //             const errorText = await response.text();
                    //             console.error('åŠ å…¥è³¼ç‰©è»Š API éŒ¯èª¤:', errorText);

                    //             if (response.status === 401) {
                    //                 alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    //                 window.location.href = '/VitalBridge/index.html';
                    //                 return;
                    //             }

                    //             throw new Error(errorText || 'åŠ å…¥è³¼ç‰©è»Šå¤±æ•—');
                    //         }

                    //         // ğŸ”¥ å¾Œç«¯å›å‚³ç´”æ–‡å­—ï¼Œä¸æ˜¯ JSON
                    //         const result = await response.text();
                    //         console.log('åŠ å…¥è³¼ç‰©è»ŠæˆåŠŸ:', result);

                    //         // æˆåŠŸæç¤º
                    //         alert(' å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼');

                    //         // æ›´æ–°å°è¦½åˆ—è³¼ç‰©è»Šæ•¸é‡
                    //         this.updateCartCount();

                    //     } catch (error) {
                    //         console.error('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
                    //         alert('âŒ åŠ å…¥è³¼ç‰©è»Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                    //     } finally {
                    //         this.addingToCart = false;
                    //     }
                    // },

                    //åŠ å…¥è³¼ç‰©è»Š
                    // ğŸ”¥ ä¿®æ­£ï¼šåŠ å…¥è³¼ç‰©è»Šæ–¹æ³•
                    async addToCartFromList(product) {
                        console.log('=== å•†å“åˆ—è¡¨ï¼šåŠ å…¥è³¼ç‰©è»Š ===', product.id);

                        try {
                            this.addingToCartId = product.id;  // è¨­å®šè¼‰å…¥ç‹€æ…‹

                            // ä½¿ç”¨å¿«é€ŸåŠ å…¥è³¼ç‰©è»Šæ–¹æ³•
                            await CartUtils.quickAddToCart(product.id, 1);

                        } catch (error) {
                            console.error('å•†å“åˆ—è¡¨åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
                            // éŒ¯èª¤è™•ç†å·²ç¶“åœ¨ CartUtils ä¸­å®Œæˆ
                        } finally {
                            this.addingToCartId = null;  // æ¸…é™¤è¼‰å…¥ç‹€æ…‹
                        }
                    },

                    // æª¢æŸ¥å•†å“æ˜¯å¦æ­£åœ¨åŠ å…¥è³¼ç‰©è»Š
                    isAddingToCart(productId) {
                        return this.addingToCartId === productId;
                    },



                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šåˆ‡æ›æˆ‘çš„æœ€æ„›
                    toggleFavorite(productId) {
                        const index = this.favorites.indexOf(productId);

                        if (index > -1) {
                            this.favorites.splice(index, 1);
                        } else {
                            this.favorites.push(productId);
                        }

                        localStorage.setItem('vitalbridge_favorites', JSON.stringify(this.favorites));
                    },

                    // æ²¿ç”¨é¦–é çš„æ–¹æ³•ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæˆ‘çš„æœ€æ„›
                    isFavorite(productId) {
                        return this.favorites.includes(productId);
                    },

                    // ğŸ”¥ ä¿®æ­£ checkLoginStatus æ–¹æ³•
                    checkLoginStatus() {
                        try {
                            const token = auth.getAccessToken();
                            return !!token;
                        } catch (error) {
                            console.error('æª¢æŸ¥ç™»å…¥ç‹€æ…‹å¤±æ•—:', error);
                            return false;
                        }
                    },
                    // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°è³¼ç‰©è»Šæ•¸é‡æ–¹æ³•
                    async updateCartCount() {
                        try {
                            const response = await fetch('https://localhost:7104/api/CartApi/Count', {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${auth.getAccessToken()}`
                                },
                                credentials: 'include'
                            });

                            if (response.ok) {
                                const count = await response.json();
                                const cartCountElement = document.getElementById('cart-count');
                                if (cartCountElement) {
                                    cartCountElement.textContent = count || 0;
                                    console.log('è³¼ç‰©è»Šæ•¸é‡æ›´æ–°ç‚º:', count);
                                }
                            }
                        } catch (error) {
                            console.error('æ›´æ–°è³¼ç‰©è»Šæ•¸é‡å¤±æ•—:', error);
                        }
                    },


                    // è™•ç†æ’åºè®Šæ›´
                    handleSortChange() {
                        this.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
                        this.updateUrlAndFetch();
                    },

                    // è™•ç†æ¯é æ•¸é‡è®Šæ›´
                    handlePageSizeChange() {
                        this.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
                        this.updateUrlAndFetch();
                    },
                    // å‰å¾€æŒ‡å®šé é¢
                    goToPage(pageNumber) {
                        if (pageNumber < 1 || pageNumber > this.pagination.totalPages) return;
                        if (pageNumber === this.currentPage) return;

                        this.currentPage = pageNumber;
                        this.updateUrlAndFetch();
                    },

                    // è¨ˆç®—è¦é¡¯ç¤ºçš„é ç¢¼
                    getPageNumbers() {
                        const current = this.pagination.currentPage;
                        const total = this.pagination.totalPages;
                        const range = 2; // ç•¶å‰é é¢å‰å¾Œé¡¯ç¤ºçš„é æ•¸

                        let start = Math.max(1, current - range);
                        let end = Math.min(total, current + range);

                        // å¦‚æœç¸½é æ•¸å°æ–¼ç­‰æ–¼5ï¼Œé¡¯ç¤ºå…¨éƒ¨
                        if (total <= 5) {
                            start = 1;
                            end = total;
                        }

                        const pages = [];
                        for (let i = start; i <= end; i++) {
                            pages.push(i);
                        }

                        return pages;
                    },
                    // æ›´æ–° URL ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                    updateUrlAndFetch() {
                        const params = new URLSearchParams();

                        if (this.currentCategoryId) params.append('categoryId', this.currentCategoryId);
                        if (this.currentSearchQuery) params.append('searchQuery', this.currentSearchQuery);
                        if (this.currentSortBy !== 'newest') params.append('sortBy', this.currentSortBy);
                        params.append('page', this.currentPage);
                        if (this.pageSize !== 12) params.append('pageSize', this.pageSize);

                        const newUrl = `${window.location.pathname}?${params.toString()}`;
                        window.history.replaceState({}, '', newUrl);

                        this.fetchProducts();
                    }
                }
            }).mount('#category-app');

            console.log("Category Vue mount æˆåŠŸï¼");
        })();

    });
</script>

</html>