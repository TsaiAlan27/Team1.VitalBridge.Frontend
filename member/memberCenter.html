<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>會員中心 - 樂齡橋 VitalBridge</title>
    <link href="/assets/img/favicon.png" rel="icon" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700;900&family=Raleway:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet" />
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />
    <link href="/assets/css/main.css" rel="stylesheet" />
    <link href="/assets/css/member-center.css" rel="stylesheet" />
</head>

<body>
    <div class="headerpage"></div>
    <main class="main py-4">
        <div class="container" data-aos="fade-up">
            <div class="row member-layout-row">
                <!-- 側邊導覽（純功能，不含頭像空間） -->
                <aside class="col-lg-3 col-xl-2 member-sidebar mb-3 mb-lg-0">
                    <nav class="nav flex-lg-column nav-pills gap-2 w-100" id="memberTab" role="tablist">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-dashboard"
                            type="button" role="tab">概覽</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-profile" type="button"
                            role="tab">個人資料</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-orders" type="button"
                            role="tab">訂單 / 紀錄</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-notify" type="button"
                            role="tab">通知中心</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-faq" type="button"
                            role="tab">常見問題</button>
                    </nav>
                </aside>
                <!-- 主內容 -->
                <div class="col-lg-9 col-xl-10">
                    <!-- 上方資訊列 -->
                    <div class="member-header mb-4">
                        <div class="row g-3 align-items-stretch">
                            <div class="col-12 col-md-6 info-col">
                                <h4 class="mb-1" id="memberName">--</h4>
                                <div class="text-muted small" id="memberEmail">--</div>
                                <div class="member-roles" id="memberRoles" hidden></div>
                            </div>
                            <div class="col-12 col-md-6 stats-col col-divider">
                                <div class="stats-col-inner member-quick-stats d-flex flex-wrap align-items-center">
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statUnread">--</div>
                                        <div class="stat-label">未讀通知</div>
                                    </div>
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statOrders">--</div>
                                        <div class="stat-label">訂單數</div>
                                    </div>
                                    <div class="stat-box text-center">
                                        <div class="stat-val" id="statLastLogin">--</div>
                                        <div class="stat-label">最後登入</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-content member-content-area" id="memberTabContent">
                        <!-- 概覽 -->
                        <div class="tab-pane fade show active" id="pane-dashboard" role="tabpanel">
                            <div class="dashboard-quick-actions mb-4">
                                <div class="quick-actions-grid" id="quickActions">
                                    <div class="quick-action-card qa-profile" data-bs-toggle="pill"
                                        data-bs-target="#pane-profile" role="button" tabindex="0" aria-label="前往個人資料">
                                        <div class="qa-icon"><i class="bi bi-person-lines-fill"></i></div>
                                        <p class="qa-title">個人資料</p>
                                        <p class="qa-value" id="qaProfilePercent">--%</p>
                                        <div class="qa-meta">完整度</div>
                                    </div>
                                    <div class="quick-action-card qa-orders" data-bs-toggle="pill"
                                        data-bs-target="#pane-orders" role="button" tabindex="0" aria-label="前往訂單紀錄">
                                        <div class="qa-icon"><i class="bi bi-bag-check"></i></div>
                                        <p class="qa-title">訂單</p>
                                        <p class="qa-value" id="qaOrdersCount">--</p>
                                        <div class="qa-meta">筆數</div>
                                    </div>
                                    <div class="quick-action-card qa-notify" data-bs-toggle="pill"
                                        data-bs-target="#pane-notify" role="button" tabindex="0" aria-label="前往通知中心">
                                        <div class="qa-icon"><i class="bi bi-bell"></i></div>
                                        <p class="qa-title">通知</p>
                                        <p class="qa-value" id="qaNotifyUnread">--</p>
                                        <div class="qa-meta">未讀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body p-3 p-md-4">
                                    <h5 class="card-title mb-3">歡迎回來</h5>
                                    <p class="text-muted small mb-0">在上方資訊列可快速查看您的帳號概況，使用左側（或上方）導覽切換功能。</p>
                                </div>
                            </div>
                            <div class="card border-0 shadow-sm mb-4" id="orderStatusSummaryCard">
                                <div class="card-body p-3 p-md-4">
                                    <h6 class="card-title mb-3">訂單狀態概覽</h6>
                                    <div class="order-status-summary">
                                        <div class="oss-item status-unpaid">
                                            <div class="oss-icon"><i class="bi bi-exclamation-circle"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">未付款</span>
                                                <span class="oss-val" id="ossUnpaid">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-paid">
                                            <div class="oss-icon"><i class="bi bi-credit-card"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">已付款</span>
                                                <span class="oss-val" id="ossPaid">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-toship">
                                            <div class="oss-icon"><i class="bi bi-box-seam"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">待出貨</span>
                                                <span class="oss-val" id="ossToShip">0</span>
                                            </div>
                                        </div>
                                        <div class="oss-item status-shipped">
                                            <div class="oss-icon"><i class="bi bi-truck"></i></div>
                                            <div class="oss-text">
                                                <span class="oss-label">已出貨</span>
                                                <span class="oss-val" id="ossShipped">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 個人資料 -->
                        <div class="tab-pane fade" id="pane-profile" role="tabpanel">
                            <div class="card border-0 shadow-sm profile-card mb-4">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                                        <h4 class="mb-0">個人資料</h4>
                                        <div class="small text-muted d-flex align-items-center gap-2">
                                            <span
                                                class="badge bg-light text-secondary fw-normal border profile-completeness-badge"
                                                id="profileCompletenessBadge">完整度 <span
                                                    id="qaProfilePercentInline">--%</span></span>
                                        </div>
                                    </div>
                                    <div class="profile-id-line">會員編號：<span id="profileId">--</span></div>
                                    <form id="formProfile" class="align-items-start">
                                        <!-- 區塊：基本資料 -->
                                        <div class="profile-section">
                                            <div class="profile-section-title"><i class="bi bi-person-badge"></i> 基本資料
                                            </div>
                                            <div class="row g-3 g-md-4">
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">姓名</label><input type="text"
                                                        class="form-control" id="profileName" required></div>
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">Email</label><input type="email"
                                                        class="form-control" id="profileEmail" disabled></div>
                                                <div class="col-md-4 col-sm-6"><label
                                                        class="form-label">電話</label><input type="tel"
                                                        class="form-control" id="profilePhone"></div>
                                            </div>
                                        </div>
                                        <!-- 區塊：地址 -->
                                        <div class="profile-section">
                                            <div class="profile-section-title"><i class="bi bi-geo-alt"></i> 地址</div>
                                            <div class="row g-3 g-md-4">
                                                <div class="col-md-3 col-sm-6"><label class="form-label">縣市</label>
                                                    <select id="profileCity" class="form-select">
                                                        <option value="">請選擇</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 col-sm-6"><label class="form-label">鄉鎮</label>
                                                    <select id="profileDistrict" class="form-select" disabled>
                                                        <option value="">請先選縣市</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 col-12"><label
                                                        class="form-label">詳細地址</label><input type="text"
                                                        class="form-control" id="profileAddressDetail"
                                                        placeholder="例如: 建業路15號2樓1室"></div>
                                            </div>
                                        </div>
                                        <!-- 區塊：時間資訊 (簡單三行) -->
                                        <div class="profile-times small text-muted mb-3">
                                            <div>建立時間：<span id="profileCreatedAt">--</span></div>
                                            <div>最後修改：<span id="profileUpdatedAt">--</span></div>
                                            <div>最後登入：<span id="profileLastLoginAt">--</span></div>
                                        </div>
                                        <!-- 區塊：操作 -->
                                        <div class="profile-section mb-0 pb-0 border-0">
                                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                                <button class="btn btn-primary" type="submit">儲存變更</button>
                                                <span id="profileSaveStatus" class="text-muted small"></span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- 訂單 / 紀錄 -->
                        <div class="tab-pane fade" id="pane-orders" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">訂單 / 紀錄</h4>
                                <div><select id="orderFilter" class="form-select form-select-sm d-inline-block w-auto">
                                        <option value="all">全部</option>
                                        <option value="unpaid">未付款</option>
                                        <option value="paid">已付款</option>
                                        <option value="toShip">待出貨</option>
                                        <option value="shipped">已出貨</option>
                                    </select></div>
                            </div>
                            <div id="ordersList" class="list-group small">
                                <div class="text-muted">載入中...</div>
                            </div>
                        </div>
                        <!-- 通知中心 -->
                        <div class="tab-pane fade" id="pane-notify" role="tabpanel">
                            <h4 class="mb-3">通知中心</h4>
                            <div id="notifyList" class="list-group small">
                                <div class="text-muted">載入中...</div>
                            </div>
                        </div>
                        <!-- FAQ -->
                        <div class="tab-pane fade" id="pane-faq" role="tabpanel">
                            <h4 class="mb-3">常見問題</h4>
                            <div class="accordion" id="faqAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="faq1h"><button class="accordion-button"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#faq1">如何修改個人資料？</button></h2>
                                    <div id="faq1" class="accordion-collapse collapse show"
                                        data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">在「個人資料」分頁編輯後按儲存即可。</div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="faq2h"><button class="accordion-button collapsed"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#faq2">忘記密碼怎麼辦？</button></h2>
                                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">目前可透過客服或 Google 登入找回。</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="footerpage"></div>
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <div id="preloader"></div>
    <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/vendor/php-email-form/validate.js"></script>
    <script src="/assets/vendor/aos/aos.js"></script>
    <script src="/assets/vendor/waypoints/noframework.waypoints.js"></script>
    <script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
    <script src="/assets/js/fragment-loader.js" defer></script>
    <script src="/assets/js/member-center.js" defer></script>
    <script>
        // 強制需登入：未登入則導回首頁並開登入 modal（若可行）
        async function requireLogin() {
            if (typeof auth === 'undefined') { console.warn('auth 模組尚未載入'); return; }
            try { await auth.me(); return true; } catch (e) {
                // 直接導回首頁（首頁上的攔截程式或彈窗由 header 統一處理）
                window.location.href = '/VitalBridge/index.html?needLogin=1';
                return false;
            }
        }

        (function onFullyReady(run) {
            function once(ev) { return new Promise(res => { function h(e) { window.removeEventListener(ev, h); res(e); } window.addEventListener(ev, h); }); }
            function waitAppReady() { if (window.appReadyAt !== undefined) return Promise.resolve(); return once('app:ready'); }
            function waitWindowLoad() { if (document.readyState === 'complete') return Promise.resolve(); return once('load'); }
            Promise.all([waitAppReady(), waitWindowLoad()]).then(run).catch(e => console.error('post-load hook error', e));
        })(async function () {
            const ok = await requireLogin();
            if (!ok) return;
            initMemberPage();
        });

        async function initMemberPage() {
            try {
                const user = await auth.me();
                $('#memberName').text(user.name || '未命名');
                $('#memberEmail').text(user.email || '');
                renderUserRoles(user);
                // mock stats
                $('#statUnread').text('0');
                $('#statOrders').text('0');
                const now = new Date();
                $('#statLastLogin').text(formatDateTime(now));
                updateQuickProfileCompleteness();
                loadOrders();
                loadNotifies();
                populateProfileMeta(user);
            } catch (e) {
                $('.member-content-area').html('<div class="alert alert-warning">請先登入後再查看會員中心。</div>');
            }
            bindForms();
        }

        function bindForms() {
            $('#formProfile').on('submit', async function (e) {
                e.preventDefault();
                // 交由 member-center.js 的 updateProfile 控制；此處不再顯示 mock 文字
                if (window.memberCenter && typeof window.memberCenter.updateProfile === 'function') {
                    window.memberCenter.updateProfile();
                }
            });
            $('#orderFilter').on('change', function () { loadOrders(); });
        }

        function extractRoles(user) {
            if (!user || typeof user !== 'object') return [];
            const roleKeys = Object.keys(user).filter(k => /(roles|claims|identit|權限|角色)/i.test(k));
            let collected = [];
            for (const k of roleKeys) {
                const v = user[k];
                if (Array.isArray(v)) collected = collected.concat(v);
                else if (typeof v === 'string' && v.length && v.indexOf(',') > -1) collected = collected.concat(v.split(',').map(s => s.trim()));
                else if (typeof v === 'string' && v.length) collected.push(v.trim());
            }
            // 常見單一屬性
            if (user.role && !collected.length) collected.push(user.role);
            if (collected.length === 0 && user.isAdmin) collected.push('Admin');
            return [...new Set(collected.filter(Boolean))];
        }

        function roleBadgeClass(r) {
            const name = (r || '').toLowerCase();
            if (/admin|管理/.test(name)) return 'role-admin';
            if (/vip|premium|尊榮/.test(name)) return 'role-alt';
            if (/pending|未驗證|unverified/.test(name)) return 'role-warn';
            return '';
        }

        function renderUserRoles(user) {
            const roles = extractRoles(user);
            const box = document.getElementById('memberRoles');
            if (box) {
                if (!roles.length) { box.hidden = true; box.innerHTML = ''; }
                else { box.hidden = false; box.innerHTML = roles.map(r => `<span class="badge ${roleBadgeClass(r)}">${r}</span>`).join(''); }
            }
        }

        let allOrders = [];
        async function loadOrders() {
            const status = $('#orderFilter').val();
            // mock 加入多種狀態示例
            allOrders = [
                { id: 'O20250001', status: 'unpaid', total: 1234, date: '2025-08-01' },
                { id: 'O20250002', status: 'paid', total: 560, date: '2025-08-15' },
                { id: 'O20250003', status: 'toShip', total: 890, date: '2025-08-18' },
                { id: 'O20250004', status: 'shipped', total: 320, date: '2025-08-20' }
            ];
            const filtered = allOrders.filter(o => status === 'all' || o.status === status);
            const statusLabel = { unpaid: '未付款', paid: '已付款', toShip: '待出貨', shipped: '已出貨' };
            const list = filtered.map(o => `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><span><strong>${o.id}</strong><br><span class=\"text-muted small\">${o.date}</span></span><span class=\"badge bg-secondary\">${statusLabel[o.status] || o.status}</span></a>`).join('');
            $('#ordersList').html(list || '<div class="text-muted">無資料</div>');
            // 更新總數與快捷卡
            $('#statOrders').text(allOrders.length);
            $('#qaOrdersCount').text(allOrders.length);
            if (!allOrders.length) $('#qaOrdersCount').closest('.quick-action-card').addClass('dimmed'); else $('#qaOrdersCount').closest('.quick-action-card').removeClass('dimmed');
            updateOrderStatusSummary();
        }

        function updateOrderStatusSummary() {
            const counts = { unpaid: 0, paid: 0, toShip: 0, shipped: 0 };
            allOrders.forEach(o => { if (counts[o.status] !== undefined) counts[o.status]++; });
            $('#ossUnpaid').text(counts.unpaid);
            $('#ossPaid').text(counts.paid);
            $('#ossToShip').text(counts.toShip);
            $('#ossShipped').text(counts.shipped);
        }

        async function loadNotifies() {
            try { const res = await auth.apiFetch('/getNotify', { method: 'GET' }); if (!res.ok) throw new Error('fetch failed'); const data = await res.json(); if (!Array.isArray(data) || !data.length) { $('#notifyList').html('<div class="text-muted">暫無通知</div>'); return; } const html = data.map(n => `<div class=\"list-group-item\"><div class=\"d-flex justify-content-between\"><strong>${n.name || '通知'}</strong><span class=\"small text-muted\">${n.sendDate || ''}</span></div><div class=\"small\">${n.title || ''}</div>${n.notifysUrl ? `<a href=\"${n.notifysUrl}\" class=\"small\">前往</a>` : ''}</div>`).join(''); $('#notifyList').html(html); $('#statUnread').text(data.length); } catch (e) { $('#notifyList').html('<div class="text-muted">無法取得通知或尚未登入</div>'); }
            // 更新快捷未讀
            const unread = parseInt($('#statUnread').text(), 10) || 0;
            $('#qaNotifyUnread').text(unread);
            if (!unread) $('#qaNotifyUnread').closest('.quick-action-card').classList.add('dimmed');
        }

        function updateQuickProfileCompleteness() {
            // 基於目前填寫欄位簡單計算（姓名 / 電話 / 縣市 / 鄉鎮 / 詳細地址）
            const fields = ['#profileName', '#profilePhone', '#profileCity', '#profileDistrict', '#profileAddressDetail'];
            let filled = 0;
            fields.forEach(sel => { const v = $(sel).val?.() || ''; if (v && v.trim().length > 0) filled++; });
            const percent = Math.round((filled / fields.length) * 100);
            $('#qaProfilePercent').text(percent + '%');
            $('#qaProfilePercentInline').text(percent + '%');
            const card = $('#qaProfilePercent').closest('.quick-action-card');
            if (percent < 40) card.addClass('dimmed'); else card.removeClass('dimmed');
            // 百分比徽章色彩
            const badge = $('#profileCompletenessBadge');
            badge.removeClass('pc-low pc-mid pc-high');
            if (percent < 40) badge.addClass('pc-low');
            else if (percent < 80) badge.addClass('pc-mid');
            else badge.addClass('pc-high');
        }

        function populateProfileMeta(user) {
            if (!user) return;
            // 不在這裡預先顯示主鍵/會員編號，避免在 member-center.js 正式取得 profile 前出現閃爍或顯示真實主鍵
            // 真正的顯示（含可能的遮罩/格式化）交由 assets/js/member-center.js 的 fill() 處理
            $('#profileId').text('--');
            // 填寫基本欄位（若後端已有資料）
            if (user.name) $('#profileName').val(user.name);
            if (user.phone) $('#profilePhone').val(user.phone);
            if (user.email) $('#profileEmail').val(user.email);
            // 移除 bio 欄位
            // 地址拆解：嘗試以 縣/市 + 鄉/鎮/區
            const fullAddr = user.address || user.addr || '';
            if (fullAddr) {
                const m = fullAddr.match(/^(.{2,3}[市縣])\s?(.{2,3}[鄉鎮市區])\s?(.*)$/);
                if (m) {
                    if (m[1]) $('#profileCity').val(m[1]);
                    if (m[2]) $('#profileDistrict').val(m[2]);
                    if (m[3]) $('#profileAddressDetail').val(m[3]);
                } else {
                    $('#profileAddressDetail').val(fullAddr);
                }
            }
            // 時間欄位
            const created = user.createdAt || user.created_at || user.createTime || user.createdDate;
            const updated = user.updatedAt || user.updated_at || user.modifyTime || user.modifiedDate || user.lastModifiedAt;
            const lastLogin = user.lastLoginAt || user.last_login_at || user.lastLogin || user.lastLoginTime;
            if (created) $('#profileCreatedAt').text(formatDateTime(created));
            if (updated) $('#profileUpdatedAt').text(formatDateTime(updated));
            if (lastLogin) $('#profileLastLoginAt').text(formatDateTime(lastLogin)); else $('#profileLastLoginAt').text($('#statLastLogin').text());
            updateQuickProfileCompleteness();
            // 初始化完整度徽章同步
            $('#qaProfilePercentInline').text($('#qaProfilePercent').text());
        }

        // 監聽個資欄位變更動態更新完整度
        $(document).on('input change', '#formProfile input', function () { updateQuickProfileCompleteness(); });

        function formatDateTime(dt) {
            try {
                const d = (dt instanceof Date) ? dt : new Date(dt);
                if (isNaN(d.getTime())) return '--';
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day} ${hh}:${mm}`;
            } catch { return '--'; }
        }
    </script>
</body>

</html>